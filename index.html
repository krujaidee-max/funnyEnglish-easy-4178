<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>funny english ‡∏õ.1</title>

<style>
/* ‡∏ü‡∏≠‡∏ô‡∏ï‡πå/‡∏ò‡∏µ‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô */
@font-face{
  font-family: 'MyGameFont';
  src: url('image/THSarabunNew.woff2') format('woff2'),
       url('image/THSarabunNew.woff') format('woff'),
       url('image/THSarabunNew.ttf') format('truetype');
  font-weight: 400; font-style: normal; font-display: swap;
}
@font-face{
  font-family: 'MyGameFont';
  src: url('image/THSarabunNewBold.woff2') format('woff2'),
       url('image/THSarabunNewBold.woff') format('woff'),
       url('image/THSarabunNewBold.ttf') format('truetype');
  font-weight: 700; font-style: normal; font-display: swap;
}
html, body, button, input, select, textarea {
  font-family: 'MyGameFont', system-ui, -apple-system, 'Segoe UI', Arial, sans-serif;
}
:root{
  --glass: rgba(0,0,0,.45);
  --ok:#10b981; --bad:#ef4444;
  --opt-top: 10vh;                 /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏à‡∏≤‡∏Å‡∏ö‡∏ô (‡πÅ‡∏ñ‡∏ß‡∏õ‡∏∏‡πà‡∏°) */
  --opt-size: clamp(120px, 18vw, 200px);
  --opt-gap: 18vw;   /* ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏°‡∏≤‡∏Å */

  /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
  --q-bottom: 8vh;                 /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏à‡∏≤‡∏Å‡∏•‡πà‡∏≤‡∏á */
  --q-font: clamp(50px, 10vw, 96px);
  --q-slide-ms: 750ms;             /* ‡πÄ‡∏ß‡∏•‡∏≤ slide ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ */
  --q-offset-x: 22vw;              /* ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏≠‡∏Å‡∏à‡∏≠ (‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô) */

  --hud-top: 14px;
  --safe-top: env(safe-area-inset-top,0px);
}

/* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á */
html,body{ height:100%; margin:0 }
body{
  background:url("image/background2.png") center/cover no-repeat fixed;
  overflow:hidden; color:#fff;
}
#game{ position:relative; width:100vw; height:100vh; overflow:hidden }

/*HUD + ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤ + ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô*/
.hud{
  position:fixed;
  inset: calc(var(--safe-top) + var(--hud-top)) 5px auto 38px !important;
  display:flex; align-items:center; gap:12px; justify-content:space-between;
  pointer-events:none; z-index:40000;
}
body:not(.in-game):not(.prestart) .hud { display:none !important; }
body:not(.in-game):not(.prestart) #clock { display: none !important; }

#clock.clock-pill{
  position:fixed; top:14px; left:50%; transform:translateX(-50%);
  z-index:16000; pointer-events:none;
  --clock-size: 40px; font-size:var(--clock-size);
  background:var(--glass); backdrop-filter:blur(6px); color:#fff;
  font-weight:1000; line-height:1; border-radius:999px; padding:8px 16px;
  box-shadow:0 4px 18px rgba(0,0,0,.25); text-shadow:0 3px 10px rgba(0,0,0,.55);
}
.pill{ background:var(--glass); backdrop-filter:blur(6px); padding:8px 12px; border-radius:999px; box-shadow:0 4px 18px rgba(0,0,0,.25) }
.btn-mini{ pointer-events:auto; background:#1f2937; color:#fff; border:none; border-radius:12px; padding:8px 12px; font-weight:800; cursor:pointer; box-shadow:0 4px 18px rgba(0,0,0,.25) }
.score-label{ 
font-size:18px; 
font-weight:900; 
opacity:.95; margin:2px 0 4px; text-align:right }

/* ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô" */
.score-label{
  margin-right:16px;  /* ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ó‡∏≠‡∏á */
  margin-top:-6px;    /* ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
}


.pill.gold{
  --score-size: 46px; 
border-radius: 12px; 
padding:6px 8px; min-width: 
calc(var(--score-size)*1.6);
}
.pill.gold .num{ 
font-size:var(--score-size); 
font-weight:1000; 
letter-spacing:.5px 
}

/* ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ó‡∏≠‡∏á */
.pill.gold{
  display:flex;
  justify-content:center;  /* ‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
  align-items:center;      /* ‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
  text-align:center;
}
.pill.gold .num{
  display:block;
  width:100%;
}


/* ‡∏¢‡πâ‡∏≤‡∏¢‡∏õ‡∏∏‡πà‡∏° HUD ‡πÑ‡∏õ‡∏°‡∏∏‡∏°‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô */
.hud { position: initial !important; inset:auto !important; }
.hud .left, .hud .right{
  position:fixed !important; top:var(--hud-top) !important; z-index:50000; pointer-events:none;
}
.hud .left { left: 16px !important; }
.hud .right{ right:16px !important; }
.hud .btn-mini{ pointer-events:auto }

/* =========================
   Welcome / Landing
   ========================= */
#welcome{ position:fixed; inset:0; background:url("image/welcome.png") center/cover no-repeat fixed; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:24px; z-index:25000; transition:opacity .3s ease }
#welcome.hide{ opacity:0; pointer-events:none; visibility:hidden }
#welcome .brand{ width:min(90vw,1000px); margin-bottom:100px; display:flex; justify-content:center }
#welcome .brand img{ width:130%; height:auto; display:block; filter:drop-shadow(0 6px 18px rgba(0,0,0,.45)); animation:pulse 3s infinite ease-in-out }
#welcome #enterBtn{ padding:12px 28px; font-size:clamp(22px,4vw,36px); font-weight:1000; border:0; border-radius:16px; color:#fff; background:rgba(0,0,0,.55); box-shadow:0 10px 28px rgba(0,0,0,.35); cursor:pointer; backdrop-filter:blur(6px); border:1px solid rgba(255,255,255,.18) }
@keyframes pulse{ 0%,100%{transform:scale(1)} 50%{transform:scale(1.04)} }

#landing{ position:fixed; inset:0; display:flex; flex-direction:column; gap:22px; align-items:center; justify-content:center; background:url("image/background2.png") center/cover no-repeat fixed; z-index:20000; transition:opacity .3s ease }
#landing.hide{ opacity:0; pointer-events:none; visibility:hidden }
#landing .brand{ width:min(92vw,1100px) }
#landing .brand img{ width:100%; height:auto; display:block; filter:drop-shadow(0 10px 30px rgba(0,0,0,.6)) }
.level-menu{ display:flex; flex-direction:column; gap:14px; width:min(92vw,640px) }
.levelBtn{ width:100%; padding:10px 16px; font-size:clamp(20px,4vw,34px); font-weight:1000; border:0; border-radius:14px; color:#fff; background:rgba(0,0,0,.55); box-shadow:0 10px 28px rgba(0,0,0,.35); cursor:pointer; text-align:center; border:1px solid rgba(255,255,255,.18); backdrop-filter:blur(6px) }

/* =========================
   ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó / ‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á
   ========================= */
#startScreen{ position:fixed; inset:0; display:none; flex-direction:column; align-items:center; justify-content:center; background:rgba(0,0,0,.9); z-index:30000; text-align:center; padding:24px }
#startTitle{ font-size:clamp(26px,5vw,48px); font-weight:900; margin-bottom:10px }
#startBtn{ margin-top:12px; padding:10px 18px; border:0; border-radius:12px; font-weight:800; cursor:pointer; background:#1f2937; color:#fff }
#countdown{ display:none; font-size:clamp(56px,12vw,120px); font-weight:1000; line-height:1; margin-top:8px }


/* ====== ‡∏î‡πà‡∏≤‡∏ô 5‚Äì7: ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö "‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏•‡πâ‡∏ß‡∏ô" ====== */
:root{
  --side-size: clamp(160px, 22vw, 260px);  /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ß‡∏á‡∏Å‡∏•‡∏°‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô (‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ) */
  --side-font: clamp(44px, 8vw, 92px);     /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏™‡πà‡∏ß‡∏ô */
  --side-shadow: 0 2px 10px rgba(0,0,0,.55);
  --side-x-offset: 6vw;                    /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤ */
  --side-gap-y: 20vh;                      /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏ö‡∏ô/‡∏•‡πà‡∏≤‡∏á‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô */
  --side-top: 20vh;                        /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏à‡∏≤‡∏Å‡∏ö‡∏ô‡∏Ç‡∏≠‡∏á‡∏ß‡∏á‡πÅ‡∏£‡∏Å */
}

#sideChoices{
  position: fixed; inset: 0; z-index: 13000; pointer-events: none; 
}

.option.circle.text-only{
  width: var(--side-size); height: var(--side-size);
  border-radius: 50%;
  border: none;                      /* ‚Üê ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏ö */
  display: grid; place-items: center;
  box-shadow: var(--side-shadow);
  cursor: pointer; user-select: none;
  pointer-events: auto;
  overflow: hidden;
  background: var(--bubble-bg, linear-gradient(135deg,#22c55e,#84cc16));
  transform: translateZ(0);
}

.option.circle.text-only .label{
  color:#fff; font-weight:1000;
  font-size:var(--side-font);
  line-height:1.1;
  text-shadow:0 3px 8px rgba(0,0,0,.6);
  letter-spacing:.5px;

  /* ‡∏à‡∏±‡∏î‡∏ã‡πâ‡∏≠‡∏ô 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î (‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á .line-num ‡πÅ‡∏•‡∏∞ .line-word ‡∏ó‡∏≤‡∏á JS) */
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  text-align:center;

  /* ‡∏Å‡∏±‡∏ô‡∏ä‡∏ô‡∏Ç‡∏≠‡∏ö‡πÉ‡∏ô‡∏ß‡∏á + ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ auto-fit */
  padding-inline:6%;
  transform: scale(var(--fit-scale,1));
  transform-origin:center;

  /* ‡πÑ‡∏°‡πà‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ container ‡πÅ‡∏ï‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏á */
  white-space:normal;    /* ‡∏ï‡∏±‡∏ß container ‡∏õ‡∏Å‡∏ï‡∏¥ */
}


/* ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏•‡∏Ç (‡∏ö‡∏ô) ‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥ (‡∏•‡πà‡∏≤‡∏á) */
.option.circle.text-only .label .line-num{
  font-size:.92em;
}
.option.circle.text-only .label .line-word{
  font-size:.56em;
  margin-top:.1em;
}


/* ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á 4 ‡∏à‡∏∏‡∏î: LT/LB/RT/RB */
.bubble-pos{ position: absolute; }
.bubble-LT{ left: var(--side-x-offset);  top: var(--side-top); }
.bubble-LB{ left: var(--side-x-offset);  top: calc(var(--side-top) + var(--side-gap-y) + var(--side-size)); }
.bubble-RT{ right: var(--side-x-offset); top: var(--side-top); }
.bubble-RB{ right: var(--side-x-offset); top: calc(var(--side-top) + var(--side-gap-y) + var(--side-size)); }

/* ‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å‡πÄ‡∏ü‡∏£‡∏°‡∏™‡∏ß‡∏¢ ‡πÜ */
.bubble-pre{ opacity: 0; transform: translateY(-30px) scale(.92); }
.bubble-in { opacity: 1; transform: translateY(0) scale(1); transition: transform 520ms cubic-bezier(.2,.9,.2,1), opacity 520ms; }
.bubble-chosen{ animation: bubblePop .5s ease forwards; }
.bubble-fade  { animation: bubbleFade .42s ease forwards; }
@keyframes bubblePop{ 0%{transform:scale(1)} 38%{transform:scale(1.12)} 100%{transform:scale(.85); opacity:0} }
@keyframes bubbleFade{ to{ transform: translateY(-20px); opacity: 0 } }
/* ===== Pulse ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤ (‡πÉ‡∏ä‡πâ‡πÅ‡∏Ñ‡πà box-shadow ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏á‡∏≤ ‡πÑ‡∏°‡πà‡πÑ‡∏õ‡∏ä‡∏ô transform ‡πÄ‡∏î‡∏¥‡∏°) ===== */
:root{
  --pulse-ms: 2200ms;  /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡πâ‡∏ô‡∏ä‡∏µ‡∏û‡∏à‡∏£ (‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ) */
}

/* ‡∏™‡∏±‡πà‡∏á pulse ‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ */
.option.circle.text-only{
  animation: bubblePulse var(--pulse-ms) ease-in-out infinite;
}

@media (max-width: 480px){
  :root{
    --side-size: clamp(150px, 42vw, 220px);
    --side-font: clamp(36px, 9vw, 88px);
  }
}


/* ‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô: ‡πÄ‡∏á‡∏≤‡∏ß‡∏á‡πÅ‡∏´‡∏ß‡∏ô‡∏ã‡πâ‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πà‡∏≠‡∏¢ ‡πÜ ‡∏à‡∏≤‡∏á‡∏≠‡∏≠‡∏Å */
@keyframes bubblePulse{
  0%, 100%{
    box-shadow:
      var(--side-shadow),
      0 0 0 0 rgba(255,255,255,.22);
  }
  70%{
    box-shadow:
      var(--side-shadow),
      0 0 0 20px rgba(255,255,255,0);
  }
}

/* ========================= */

/* ‡πÅ‡∏ñ‡∏ß‡∏õ‡∏∏‡πà‡∏° 3 ‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô */
#choicesRow{
  position:fixed; left:50%; transform:translateX(-50%);
  top:var(--opt-top); display:flex; gap:var(--opt-gap);
  z-index:12000; pointer-events:auto;
}

.option.circle{
  width:var(--opt-size); height:var(--opt-size);
  border-radius:50%;
  /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡πâ‡∏°‡∏Å‡∏ß‡πà‡∏≤‡∏™‡∏µ‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
  border:10px solid rgba(0,0,0,0.25);
  background:
    radial-gradient(35% 35% at 30% 30%, rgba(255,255,255,.18), rgba(255,255,255,0) 60%) padding-box,
    var(--ring, linear-gradient(130deg,#999,#666)) border-box;
  box-shadow:0 8px 28px rgba(0,0,0,.35);
  display:grid; place-items:center; cursor:pointer; user-select:none;
  overflow:hidden;
}

.option.circle img{ width:80%; height:80%; object-fit:contain; filter:drop-shadow(0 6px 14px rgba(0,0,0,.45)) }
.option.circle.pre-in{ opacity:0; transform:translateY(-40px); }
.option.circle.go-in{ opacity:1; transform:translateY(0); transition: transform 600ms cubic-bezier(.2,.9,.2,1), opacity 600ms; }
.option-wrap{
  display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
  gap:8px;
  position:relative;
}

.option-wrap .opt-cap {
  font-size: var(--cap-font, clamp(16px, 2.8vw, 24px));
  font-weight: 900;
  color: #fff;
  line-height: 1.45;
  text-align: center;
  text-shadow: 0 2px 6px rgba(0,0,0,.6);
  transform: translateY(var(--cap-offset-y, 0px));
  max-width: none;
  white-space: nowrap;   /* ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß */
  overflow: visible;     /* ‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î‡∏´‡∏±‡∏ß-‡∏´‡∏≤‡∏á‡∏™‡∏£‡∏∞ */
  word-break: keep-all;
}

/* ‡∏≠‡∏≠‡∏Å: ‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Üí ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏î‡∏à‡∏ô‡∏´‡∏≤‡∏¢ */
.option.circle.pick-pop{ animation: pickPop 620ms ease forwards; }
@keyframes pickPop{ 0%{transform:scale(1)} 45%{transform:scale(1.15)} 100%{transform:scale(.2); opacity:0} }

/* ‡∏≠‡∏≠‡∏Å: ‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Üí slide-out ‡∏Ç‡∏∂‡πâ‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô */
.option.circle.slide-up-out{ animation: slideUpOut 560ms ease forwards; }
@keyframes slideUpOut{ to{ transform:translateY(-60px); opacity:0 } }
/* ‡πÉ‡∏´‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (‡∏ß‡∏á‡∏Å‡∏•‡∏°+‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡∏ô) ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ï */
.option-wrap{ will-change: transform, opacity; }

/* ‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å = ‡∏õ‡πä‡∏≠‡∏õ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏∏‡∏ö‡∏à‡∏≤‡∏á‡∏´‡∏≤‡∏¢ (‡∏ß‡∏á+‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô) */
.option-wrap.is-chosen .option.circle{ animation: circlePop .52s cubic-bezier(.2,.9,.2,1) forwards; }
.option-wrap.is-chosen .opt-cap     { animation: capFadeUp .52s ease forwards; }

/* ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å = ‡πÄ‡∏ü‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏ö‡∏≤ ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏≤‡∏¢ (‡∏ß‡∏á+‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô) */
.option-wrap.is-faded  .option.circle{ animation: circleFadeUp .42s ease forwards; }
.option-wrap.is-faded  .opt-cap      { animation: capFadeUp .42s ease forwards; }

/* ‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ü‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ */
@keyframes circlePop{
  0%{ transform:scale(1); opacity:1 }
  35%{ transform:scale(1.12) }
  100%{ transform:scale(.85); opacity:0 }
}
@keyframes circleFadeUp{ to{ transform:translateY(-20px); opacity:0 } }
@keyframes capFadeUp{   to{ transform:translateY(-24px); opacity:0 } }
/* ‡∏à‡∏ö‡∏£‡∏≠‡∏ö: ‡∏¢‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏´‡∏≤‡∏¢ (‡∏Å‡∏±‡∏ô‡∏ä‡∏ô‡∏Å‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ) */
.option-wrap.is-vanish{
  animation: wrapShrinkOut var(--vanish-ms, 420ms) ease forwards;
}
.option-wrap.is-vanish .option.circle{
  animation: circleShrinkOut var(--vanish-ms, 420ms) ease forwards;
}
.option-wrap.is-vanish .opt-cap{
  animation: capFadeUp var(--vanish-ms, 420ms) ease forwards;
}

@keyframes wrapShrinkOut{
  to{ transform: scale(.88); opacity:.0; }
}
@keyframes circleShrinkOut{
  to{ transform: scale(.82); opacity:0; }
}

/* ‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡∏ô‡∏´‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏ß‡∏á */
@keyframes capFadeUp { to { transform: translateY(-30px); opacity: 0; } }
.option-wrap.faded .opt-cap{ animation: capFadeUp 560ms ease forwards; }
.option-wrap.chosen .opt-cap{ animation: capFadeUp 620ms ease forwards; }
#questionBox{
  position:fixed;
  left:0; right:0; bottom:var(--q-bottom);
  width:100vw; overflow:hidden; pointer-events:none;
  z-index:11000;
  text-align:left; /* ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Å‡∏•‡∏≤‡∏á ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏≠‡∏á */
  white-space:nowrap;
  /* ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏î‡∏¥‡∏° */
  font-size:var(--q-font); font-weight:1000;
  text-shadow:0 4px 12px rgba(0,0,0,.8);
}

#questionBox .mq{
  display:inline-block;
  padding-inline: 4vw;
  will-change: transform, opacity;
  /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏ü‡∏£‡∏°‡πÅ‡∏£‡∏Å‡πÇ‡∏ú‡∏•‡πà‡∏°‡∏∏‡∏°‡∏ã‡πâ‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏á */
  opacity: 0;
  transform: translateX(100vw);
  /* ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ú‡∏π‡∏Å animation ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‡∏£‡∏≠‡πÉ‡∏´‡πâ JS ‡∏™‡∏±‡πà‡∏á‡∏ï‡∏≠‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏° */
}
#questionBox .mq.run{
  opacity: 1;
  animation-name: qScrollLeft;
  animation-timing-function: linear;
  animation-iteration-count: 1; /* ‡∏ß‡∏¥‡πà‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ */
}

/* keyframes ‡∏ß‡∏¥‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏ô‡∏≠‡∏Å‡∏à‡∏≠‡∏Ç‡∏ß‡∏≤ ‡πÑ‡∏õ‡∏à‡∏ô‡∏û‡πâ‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ */
@keyframes qScrollLeft{
  from{ transform: translateX(100vw); }
  to  { transform: translateX(-100%); }
}

/* ‡πÄ‡∏£‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏≠‡∏Å‡∏ã‡πâ‡∏≤‡∏¢‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏≤‡∏á (‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö) */
@keyframes qBoostOut{
  to { transform: translateX(-120%); opacity: 0; }
}

/* ‡πÄ‡∏£‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏≠‡∏Å‡∏ã‡πâ‡∏≤‡∏¢‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏≤‡∏á (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) */
@keyframes qBoostOut{ to{ transform:translateX(-120%); opacity:0 } }

/* (‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏•‡∏≤‡∏™‡πÄ‡∏Å‡πà‡∏≤ ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏ï‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏≤‡∏Å‡∏£‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô) */
/* === ‡∏ï‡∏£‡∏≤‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÉ‡∏ï‡πâ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° === */
:root{
  --decor-w: 104vw; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
  --decor-bottom: -12vh;                /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏á */
  --cap-font: clamp(24px, 4.2vw, 36px); /* ‚Üê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡∏ô */
}

#qDecor{
  position: fixed;
  left: 50%;
  bottom: var(--decor-bottom);
  width: var(--decor-w);
  height: auto;
  transform: translateX(-50%);
  /* ‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πá‡∏ô pointer-events:none; ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ */
  pointer-events: auto;
  cursor: pointer;
  z-index: 10950;
  filter: drop-shadow(0 6px 18px rgba(0,0,0,.35));
}

/* ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å qDecor ‡πÅ‡∏ï‡πà‡∏Ñ‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡πÅ‡∏™‡∏á‡πÑ‡∏î‡πâ */
#qDecor{
  pointer-events: none; /* ‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏Ñ‡∏•‡∏¥‡∏Å ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡πÅ‡∏™‡∏á‡πÑ‡∏î‡πâ */
}

/* ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏±‡∏î‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°: ‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö object0) */
:root{
  /* ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á/‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ */
  --fast-left: 0vw;   /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏à‡∏≤‡∏Å‡∏ã‡πâ‡∏≤‡∏¢ */
  --fast-top: 88vh;   /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏à‡∏≤‡∏Å‡∏ö‡∏ô */
  --fast-w: 1840px;    /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
  --fast-h: 130px;     /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á */
}
#fastNext {
  position: fixed;
  left: 5%;
  transform: translateX(-50%);
  bottom: 1vh;
  display: none;
  font-family: 'MyGameFont';

  /* === ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á/‡∏Ç‡∏¢‡∏≤‡∏¢‡∏à‡∏≠ === */
  background: rgba(0,0,0,.4);           /* ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
  backdrop-filter: blur(4px);           /* ‡πÄ‡∏ö‡∏•‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á */
  box-shadow: 0 3px 8px rgba(0,0,0,.3);

  color: #fff;
  font-size: 1.5vw;     /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏•‡∏á */
  padding: .3em 1em;  /* ‡∏•‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏Ç‡∏≠‡∏ö‡∏£‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° */
  border-radius: 14px;  /* ‡πÇ‡∏Ñ‡πâ‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á */
  cursor: pointer;
  user-select: none;
  text-align: center;
  transition: all .15s ease;
  z-index: 12000;
}
#fastNext:hover { transform: translateX(-50%) scale(1.05); }

#fastNext.show {
  display: grid;
  place-items: center;
  opacity: 1;
}
#fastNext.arm-next{ animation: none; } /* ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏¥‡πà‡∏á‡πÜ */


:root{
  /* ‚Üê ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ */
  --post-top: 50%;          /* ‡∏£‡∏∞‡∏¢‡∏∞‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á (‡πÄ‡∏ä‡πà‡∏ô 45%, 60%) */
  --post-scale: .94;        /* ‡∏™‡πÄ‡∏Å‡∏•‡∏†‡∏≤‡∏û‡∏Ç‡∏ì‡∏∞‡πÇ‡∏ä‡∏ß‡πå */
  --post-left-offset: 4vw;  /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ */
  --post-right-offset: 4vw; /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏Ç‡∏ß‡∏≤ */
}

#postCue{
  position: fixed;
  top: var(--post-top);
  transform: translateY(-50%) scale(var(--post-scale));
  width: auto;
  height: auto;
  max-width: min(30vw, 400px);
  display: none;
  z-index: 15000;
  filter: drop-shadow(0 12px 36px rgba(0,0,0,.55));
  pointer-events: none;
}

#postCue.slot-left  { left:  var(--post-left-offset);  right: auto; }
#postCue.slot-right { right: var(--post-right-offset); left:  auto; }

#postCue.show{
  display: block;
  animation: postCuePop .28s ease-out both;
}

@keyframes postCuePop{
  from{ opacity: 0; transform: translateY(-50%) scale(.88); }
  to  { opacity: 1; transform: translateY(-50%) scale(1.0); }
}


#questionBox.pre-x, #questionBox.go-x{ opacity:1; transform:none; transition:none; }

#qImg{ display:none }

.fly-score{
  position:fixed; left:50%; top:50%;
  font-weight:1000; font-size:clamp(28px,4vw,54px);
  transform:translate(-50%,-50%); pointer-events:none; z-index:20000; opacity:0;
  animation:flyUp 900ms ease-out forwards; text-shadow:0 4px 14px rgba(0,0,0,.45);
}

/* ‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ (‡πÄ‡∏ü‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‚Äì‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡∏±‡πâ‡∏ô‡πÜ‚Äì‡πÄ‡∏ü‡∏î‡∏≠‡∏≠‡∏Å) */
#emojiBurst{
  position: fixed;
  left: 50%; top: 50%;
  transform: translate(-50%, -50%) scale(0.92);
  font-size: var(--emoji-size, 120px);   /* ‚Üê ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏î‡πâ */
  line-height: 1;
  opacity: 0;
  pointer-events: none;
  z-index: 60001;                        /* ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏ü‡∏•‡∏ä‡∏™‡∏µ */
}
#emojiBurst.on{
  animation: emojiFade var(--emoji-ms, 1000ms) ease-in-out forwards; /* ‚Üê ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ */
}
@keyframes emojiFade{
  0%   { opacity: 0; transform: translate(-50%, -50%) scale(0.92); }
  15%  { opacity: 1; transform: translate(-50%, -50%) scale(1.00); }
  85%  { opacity: 1; transform: translate(-50%, -50%) scale(1.02); }
  100% { opacity: 0; transform: translate(-50%, -50%) scale(1.04); }
}

.fly-score.ok{ color:#10b981 } .fly-score.bad{ color:#ef4444 }
@keyframes flyUp{
  0%{ opacity:0; transform:translate(-50%,-40px) scale(.96) }
  15%{ opacity:1; transform:translate(-50%,-50%) scale(1) }
  100%{ opacity:0; transform:translate(-50%,-110px) scale(1.06) }
}

/* ‡∏õ‡∏∏‡πà‡∏° Mute/Fullscreen */
#muteBtn,#fsBtn{
  position:fixed; right:12px; width:44px; height:44px; border-radius:999px;
  background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.3);
  color:#fff; font-size:18px; display:grid; place-items:center; cursor:pointer; z-index:50000;
}
#muteBtn{ bottom:12px } #fsBtn{ bottom:62px }


/* ‡∏´‡∏ô‡πâ‡∏≤ ‚Äú‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‚Äù */
#overlay{ visibility:hidden; opacity:0; transition:.25s; position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.55); z-index:9999 }
.result-panel{
  --panel-bg: rgba(20,20,20,.92);
  background:var(--panel-bg);
  border:1px solid rgba(255,255,255,.12);
  padding: clamp(20px, 4vw, 32px);
  border-radius: 20px;
  width: min(92vw, 640px);
  display:grid; gap:14px; text-align:center; box-shadow:0 20px 60px rgba(0,0,0,.55); backdrop-filter: blur(6px);
}
.result-title{ margin:0; font-weight:1000; font-size:clamp(28px,4.5vw,44px) }
.badge{ font-size: clamp(56px, 10vw, 120px); line-height:1; filter: drop-shadow(0 8px 24px rgba(0,0,0,.45)) }
.result-metrics{ display:grid; gap:12px }
.metric{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:12px; box-shadow:0 8px 24px rgba(0,0,0,.25) inset }
.metric .label{ opacity:.9 } .metric .value{ font-size:clamp(28px,5.5vw,52px); font-weight:1000 }
.result-actions{ display:flex; gap:12px; justify-content:center; flex-wrap:wrap }
.btn{ appearance:none; border:none; border-radius:14px; padding:12px 18px; font-weight:900; font-size:clamp(16px,2.8vw,20px); cursor:pointer; box-shadow:0 10px 28px rgba(0,0,0,.35) }
.btn.strong{ color:#fff; background:linear-gradient(180deg,#3b82f6,#1d4ed8); border:1px solid rgba(255,255,255,.15) }
.btn.ghost{ color:#fff; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.18) }

/* =========================
   ‡∏Å‡∏•‡πâ‡∏≠‡∏á/‡πÅ‡∏Ñ‡∏ô‡∏ß‡∏≤‡∏™ AR
   ========================= */
#cameraMirror{ position:fixed; inset:0; width:100vw; height:100vh; object-fit:cover; transform:scaleX(-1); z-index:1; display:none; background:#000 }
#camCanvas{ position:fixed; inset:0; width:100vw; height:100vh; z-index:2; pointer-events:none; display:none }
#game{ z-index:3; position:relative }

/* ‡∏°‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå) */
body::after{ content:""; position:fixed; top:0; left:0; width:220px; height:220px; background:url("image/button1.png") no-repeat left top/contain; pointer-events:none; z-index:10000 }
body::before{ content:""; position:fixed; top:0; right:0; width:200px; height:200px; background:url("image/button2.png") no-repeat right top/contain; pointer-events:none; z-index:10000 }

:root{
  --flash-ok:  rgba(16,185,129,.6);  /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
  --flash-bad: rgba(239,68,68,.6);   /* ‡πÅ‡∏î‡∏á  */
  --flash-fade-ms: 120ms;            /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏ü‡∏î‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å */
}

/* ‡πÅ‡∏ú‡πà‡∏ô‡∏ó‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏à‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ü‡∏•‡∏ä */
#flashOverlay{
  position: fixed;
  inset: 0;
  background: transparent;
  opacity: 0;
  pointer-events: none;
  z-index: 60000;           /* ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ HUD/‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */
  transition: opacity var(--flash-fade-ms) linear;
  will-change: opacity;     /* ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏•‡∏∑‡πà‡∏ô */
}
#flashOverlay.on{ opacity: 1; }

#bgLayer {
  position: fixed;
  inset: 0;
  background: url("image/background2.png") center/cover no-repeat;
  z-index: 1000;           /* ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Å‡∏° */
}

#banner2,
#enterBtn {
  position: relative;
  z-index: 2000;           /* ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ background2 */
}

/* ‡πÉ‡∏´‡πâ bgLayer ‡πÇ‡∏ú‡∏•‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô */
body.in-game #bgLayer {
  display: none !important;
}

/* ======= ‡∏û‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î ======= */
#preloadOverlay{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#000c; color:#fff; z-index:99999; flex-direction:column; gap:12px; font-weight:900 }
</style>
</head>
<body>

<!-- ==== AR Mirror ==== -->
<video id="cameraMirror" playsinline muted></video>
<canvas id="camCanvas"></canvas>

<div id="game" aria-label="‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏Å‡∏°">
  <div id="choicesRow" aria-label="‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö 3 ‡∏õ‡∏∏‡πà‡∏°"></div>
  <!-- ‡∏î‡πà‡∏≤‡∏ô 5‚Äì7 ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ (‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ 4 ‡∏ß‡∏á ‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤) -->
  <div id="sideChoices" aria-label="‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á (4 ‡∏ß‡∏á)"></div>

  <div id="questionBox" aria-live="polite"></div>
    <img id="qDecor" src="objects2/object0.png" alt="‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡πÉ‡∏ï‡πâ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°">
  <img id="qImg" alt="‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö" />
  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏±‡∏î‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°: ‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ -->
  <div id="fastNext" role="button" aria-label="‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ">NEXT</div>
  <!-- ‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ï‡∏≠‡∏ô "‡∏£‡∏≠‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ" -->
  <img id="postCue" src="image/post1.png" alt="‡∏ó‡∏≥‡∏ó‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏ï‡πà‡∏≠">
</div>

<!-- ===== Welcome ===== -->
<div id="welcome" role="dialog" aria-modal="true">
  <div class="brand"><img src="image/banner2.png" alt="‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå"></div>
  <button id="enterBtn">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÄ‡∏Å‡∏°</button>
</div>

<!-- ===== Landing ===== -->
<div id="landing" role="dialog" aria-modal="true" class="hide">
  <div class="brand"><img src="image/banner2.png" alt="‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå"></div>
  <div class="level-menu">
    <button class="levelBtn" data-level="5"> A‚ÄìZ (‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏ç‡πà)</button>
    <button class="levelBtn" data-level="6"> a‚Äìz (‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å)</button>
    <button class="levelBtn" data-level="7">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô 1-20</button>

    <button class="levelBtn" id="guideBtn">‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô üìñ</button>
  </div>
</div>

<div id="bgLayer"></div>

<!-- ===== Start / Countdown ===== -->
<div id="startScreen">
  <div id="startTitle">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à : ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏à‡∏ó‡∏¢‡πå</div>
  <button id="startBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°</button>
  <div id="countdown">3</div>
</div>

<!-- ===== Guide ===== -->
<div id="guideScreen" style="display:none; position:fixed; inset:0; align-items:center; justify-content:center; background:url('image/background2.png') center/cover no-repeat; z-index:20001">
  <div class="guide-wrap" style="width:min(95vw, 1200px); max-height:92vh; display:flex; flex-direction:column; gap:10px; align-items:center; justify-content:center">
    <img src="image/guide.png" alt="‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡πÄ‡∏Å‡∏°" style="width:100%; height:auto; max-height:92vh; border-radius:14px; box-shadow:0 20px 60px rgba(0,0,0,.55); display:block">
    <button id="guideBack" class="btn-mini">‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
  </div>
</div>

<!-- ===== HUD ===== -->
<div class="hud">
  <div class="left">
    <div class="stack">
      <div style="display:flex; gap:8px;">
        <button id="quickRestart" class="btn-mini">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        <button id="pauseBtn" class="btn-mini">‚è∏ ‡∏´‡∏¢‡∏∏‡∏î</button>
        <button id="camBtn" class="btn-mini">üì∑: ‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>
  <div class="right">
    <div class="stack" style="align-items:flex-end">
      <div class="score-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
      <div id="goldWrap" class="pill gold" aria-live="polite"><span class="num">0</span></div>
    </div>
  </div>
</div>
<div id="clock" class="clock-pill">02:00</div>

<!-- ===== Overlay ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ===== -->
<div id="overlay">
  <div class="result-panel">
    <div class="badge" id="scoreBadge" aria-hidden="true">üèÜ</div>
    <h1 class="result-title" id="endTitle">‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤</h1>
    <div class="result-metrics">
      <div class="metric">
        <div class="label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
        <div class="value"><b id="finalScore">0</b></div>
      </div>
    </div>
    <div class="result-actions">
      <button class="btn strong" id="restartBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
      <button class="btn ghost" id="selectLevelBtn">‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
    </div>
  </div>
</div>

<!-- ===== ‡πÄ‡∏™‡∏µ‡∏¢‡∏á ===== -->
<audio id="hitSound" preload="auto" src="image/audio1.mp3"></audio>
<audio id="winSound" preload="auto" src="image/win2.mp3"></audio>
<audio id="bgm" preload="auto" loop src="image/bgm3.mp3"></audio>
<audio id="selectSound" preload="auto" src="image/select.mp3"></audio>
<audio id="wrongSound" preload="auto" src="image/wrong.mp3"></audio>
<audio id="beltSound" preload="auto" src="image/belt.mp3"></audio>

<!-- ===== ‡∏õ‡∏∏‡πà‡∏° Mute / Fullscreen ===== -->
<button id="muteBtn" aria-pressed="false" title="Mute / Unmute">üîä</button>
<button id="fsBtn" aria-pressed="false" title="‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠">‚õ∂</button>

<!-- ===== ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Mute ===== -->
<script>

(function(){
  const muteBtn = document.getElementById('muteBtn');
  const bgm = document.getElementById('bgm');  // ‚Üê ‡πÄ‡∏û‡∏¥‡πà‡∏°
  if(!muteBtn || !bgm) return;
  let isMuted = false;
  function applyMute(m){
    isMuted = !!m;
    bgm.muted = isMuted;                      // ‚Üê ‡∏õ‡∏¥‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞ bgm
    if(isMuted){ bgm.setAttribute('muted',''); }
    else       { bgm.removeAttribute('muted'); }

    muteBtn.setAttribute('aria-pressed', String(isMuted));
    muteBtn.textContent = isMuted ? 'üîá' : 'üîä';
  }
  muteBtn.addEventListener('click', () => applyMute(!isMuted));
})();
</script>

<!-- ===== ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Fullscreen ===== -->
<script>
(function(){
  const fsBtn = document.getElementById('fsBtn');
  if (!fsBtn) return;
  function fsEnabled(){ return document.fullscreenEnabled || document.webkitFullscreenEnabled || document.msFullscreenEnabled }
  function isFull(){ return document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement }
  function requestFS(){ const el=document.documentElement; (el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen)?.call(el) }
  function exitFS(){ (document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen)?.call(document) }
  function render(){ const on=!!isFull(); fsBtn.setAttribute('aria-pressed', String(on)); fsBtn.title = on ? '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠' : '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠'; fsBtn.textContent = on ? 'üóó' : '‚õ∂' }
  if (!fsEnabled()){ fsBtn.style.display='none'; return }
  fsBtn.addEventListener('click', () => { if(isFull()) exitFS(); else requestFS() });
  document.addEventListener('fullscreenchange', render);
  document.addEventListener('webkitfullscreenchange', render);
  document.addEventListener('msfullscreenchange', render);
  render();
})();
</script>

<!-- ===== ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡∏°‡∏´‡∏•‡∏±‡∏Å (‡πÅ‡∏ô‡∏ß‡∏ß‡∏±‡∏™‡∏î‡∏∏‚Äì‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏) ===== -->
<script>
(()=>{
// =========================
// ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞/‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏´‡∏•‡∏±‡∏Å
// =========================
window.__ALL_IMAGES_READY__ = false;
window.currentLevel = 1; // 1: ‡∏ñ‡∏≤‡∏°‡∏ß‡∏±‡∏™‡∏î‡∏∏ ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏, 2: ‡∏ñ‡∏≤‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏ ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏

const GAME_DURATION_MS = 120000; // 2 ‡∏ô‡∏≤‡∏ó‡∏µ
let gameTimerId = null, gameEndAt = 0, remainingMs = GAME_DURATION_MS;
let running=false, ended=true, paused=false;
let awaitingContinue=false; // ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏Å‡∏î object0 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
let score=0, round=0, awaitingAnswer=false;
// ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡πà‡∏≤‡∏ô 3 (‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö)
let remainingCorrect = new Set();
let __multiCorrectSet = new Set();
let __sideChosen = new Set();     // index ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ
let __sideRequiredPicks = 1;      // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô 1 ‡∏£‡∏≠‡∏ö (‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á = 2 ‡∏ï‡∏≠‡∏ô‡∏™‡∏õ‡∏≠‡∏ô)
let __sideOkSet = new Set();      // ‡∏ä‡∏∏‡∏î index ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô "‡∏ñ‡∏π‡∏Å" ‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ

// ===== ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à =====
const NEXT_RELEASE_DELAY_MS_DEFAULT = 1500;   // ‚Üê ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 1.5s (‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ)
let NEXT_RELEASE_DELAY_MS = NEXT_RELEASE_DELAY_MS_DEFAULT;
let __postDelayTimer = null;

function continueToNextWithDelay(){
  if (ended) return;
  if (__postDelayTimer) return;                    // ‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏ã‡πâ‡∏≥‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏á
  // ‚ú® ‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ auto-skip ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß)
if (__postAutoSkipTimer){ 
  clearTimeout(__postAutoSkipTimer); 
  __postAutoSkipTimer = null; 
}
  awaitingContinue = false;                        // ‡∏õ‡∏¥‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≠‡πÑ‡∏õ‡∏ï‡πà‡∏≠
  syncFastNextUI();                                // ‡∏ã‡πà‡∏≠‡∏ô UI cue

  try{                                             // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏Ç‡πá‡∏°‡∏Ç‡∏±‡∏î (‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå)
    if (beltSound) {
      // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô
      beltSound.src = nextBeltSrc();
      beltSound.currentTime = 0;
      beltSound.muted = isGlobalMuted();
      // ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏Å‡∏î .load() ‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
      // beltSound.load();
      beltSound.play?.();
    }
  }catch(_){}


  __postDelayTimer = setTimeout(()=>{
    __postDelayTimer = null;
    nextRound();                                   // ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏á
  }, Math.max(0, NEXT_RELEASE_DELAY_MS|0));
}

  // ‚òÖ Auto-skip ‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡∏£‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô X ms (‡∏Å‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏¢‡∏≤‡∏Å)
const POST_AUTO_SKIP_MS = 10000; // 10s
let __postAutoSkipTimer = null;
const POST_DELAY_AFTER_CLEAR_MS = 1000;   // ‚Üê 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ)
let __postAfterClearTimer = null;

function enterPostPhaseAfterClearDelay(){
  if (ended) return;
  if (__postAfterClearTimer) clearTimeout(__postAfterClearTimer);

  __postAfterClearTimer = setTimeout(()=>{
    __postAfterClearTimer = null;
    // ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ä‡πà‡∏ß‡∏á‡πÇ‡∏û‡∏™‡∏ó‡πà‡∏≤‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
    selectRandomPostCue();
    awaitingContinue = true;
    qDecor?.classList.add('arm-next');
    syncFastNextUI();
    // ‚ú® ‡∏ï‡∏±‡πâ‡∏á‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ auto-skip ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡∏£‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10 ‡∏ß‡∏¥
if (__postAutoSkipTimer) { 
  clearTimeout(__postAutoSkipTimer); 
  __postAutoSkipTimer = null; 
}
__postAutoSkipTimer = setTimeout(()=>{
  if (awaitingContinue && !ended) {
    continueToNextWithDelay();  // ‡∏à‡∏∞‡πÄ‡∏•‡πà‡∏ô belt + ‡∏´‡∏ô‡πà‡∏ß‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏•‡πà‡∏≠‡∏¢ nextRound() ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á
  }
}, POST_AUTO_SKIP_MS);
  }, Math.max(0, POST_DELAY_AFTER_CLEAR_MS|0));
}

// DOM
const game = document.getElementById('game');
const choicesRow = document.getElementById('choicesRow');
const qBox = document.getElementById('questionBox');
const qDecor = document.getElementById('qDecor');
const fastNext = document.getElementById('fastNext');
const postCue = document.getElementById('postCue');   // ‚Üê ‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏£‡∏≠‡πÑ‡∏õ‡∏ï‡πà‡∏≠

// ====== Cue ‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏≠‡πÑ‡∏õ‡∏ï‡πà‡∏≠ (‡∏™‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö) ======
window.__cueActive = false;                 // ‡∏°‡∏µ cue ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏°
window.__currentPostGesture = null;         // id ‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ

// ‡πÅ‡∏°‡∏õ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á "‡∏ó‡πà‡∏≤" ‚Üî "‡∏£‡∏π‡∏õ" (post1 = ‡πÄ‡∏î‡∏¥‡∏°: ‡πÅ‡∏ï‡∏∞‡∏´‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏á)
const POST_CUES = [
  { id:'ears',     img:'image/post1.png',  desc:'‡πÅ‡∏ï‡∏∞‡∏´‡∏π‡∏ã‡πâ‡∏≤‡∏¢‚Äì‡∏Ç‡∏ß‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô' },
  { id:'overhead', img:'image/post2.png',  desc:'‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏°‡∏∑‡∏≠‡∏ä‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏´‡∏±‡∏ß' },     // post2
  { id:'underhead',img:'image/post3.png',  desc:'‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏°‡∏∑‡∏≠‡∏ä‡∏ô‡∏Å‡∏±‡∏ô‡πÉ‡∏ï‡πâ‡∏Ñ‡∏≤‡∏á/‡πÉ‡∏ï‡πâ‡∏´‡∏±‡∏ß' }, // post3
  { id:'leg',      img:'image/post4.png',  desc:'‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏°‡∏∑‡∏≠‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏î‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á' }, // post4
  { id:'chinSide', img:'image/post6.png',  desc:'‡∏°‡∏∑‡∏≠‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÅ‡∏ï‡∏∞‡∏Ñ‡∏≤‡∏á ‡∏≠‡∏µ‡∏Å‡∏°‡∏∑‡∏≠‡∏ä‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á' }, // post6
  { id:'bodybuilder', img:'image/post7.png',  desc:'‡πÅ‡∏Ç‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÅ‡∏ï‡∏∞‡πÄ‡∏≠‡∏ß/‡∏ó‡πâ‡∏≠‡∏á ‡∏≠‡∏µ‡∏Å‡πÅ‡∏Ç‡∏ô‡∏¢‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏®‡∏µ‡∏£‡∏©‡∏∞' }, // post7
  { id:'splitLegs',   img:'image/post8.png',  desc:'‡πÅ‡∏¢‡∏Å‡∏Ç‡∏≤‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏±‡∏ß‡πÑ‡∏´‡∏•‡πà' },                    // post8
  { id:'gunStack',    img:'image/post10.png', desc:'‡∏ä‡∏µ‡πâ‡∏°‡∏∑‡∏≠‡∏™‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏á‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (‡πÅ‡∏Ç‡∏ô‡∏ã‡πâ‡∏≠‡∏ô)' }, // post10
  { id:'oBelly',      img:'image/post13.png', desc:'‡∏õ‡∏£‡∏∞‡∏Å‡∏ö‡∏°‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏á‡πÇ‡∏≠‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡πâ‡∏≠‡∏á' },               // post13
  { id:'xChest',      img:'image/post14.png', desc:'‡πÑ‡∏Ç‡∏ß‡πâ‡πÅ‡∏Ç‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ X ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏Å' },                // post14
  { id:'monkey',      img:'image/post15.png', desc:'‡∏°‡∏∑‡∏≠‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÅ‡∏ï‡∏∞‡∏´‡∏±‡∏ß ‡∏≠‡∏µ‡∏Å‡∏°‡∏∑‡∏≠‡πÅ‡∏ï‡∏∞‡∏ó‡πâ‡∏≠‡∏á (‡∏ó‡πà‡∏≤‡∏•‡∏¥‡∏á)' },     // post15
  { id:'sitKnees',    img:'image/post16.png', desc:'‡∏ô‡∏±‡πà‡∏á ‡∏°‡∏∑‡∏≠‡∏™‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏á‡πÅ‡∏ï‡∏∞‡∏Ç‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ç‡πà‡∏≤' },           // post16
  { id:'splitArmsUp', img:'image/post17.png', desc:'‡πÅ‡∏¢‡∏Å‡∏Ç‡∏≤‡∏Å‡∏ß‡πâ‡∏≤‡∏á + ‡∏ä‡∏π‡∏°‡∏∑‡∏≠‡∏™‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏´‡∏±‡∏ß' },     // post17
  { id:'armAtHead', img:'image/post19.png', desc:'‡πÅ‡∏Ç‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ç‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏®‡∏µ‡∏£‡∏©‡∏∞' }, // post19
];

// --- Shuffle-bag deck ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥‡∏ó‡πà‡∏≤‡∏ã‡πâ‡∏≥ ‡πÜ ---
let __cueDeck = [];
let __lastCue = null;            // ‡∏à‡∏≥‡∏ó‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏ß‡πâ‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏±‡∏ß‡πÄ‡∏î‡πá‡∏Ñ
const __CUE_RECENT_AVOID = 1;    // ‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î N ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï)

// ‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡∏£‡∏±‡∏ö + ‡∏™‡∏∏‡πà‡∏°‡∏™‡∏±‡∏ö
function refillCueDeck(){
  __cueDeck = POST_CUES.map(c => c.id);
  // ‡∏™‡∏∏‡πà‡∏°‡πÅ‡∏ö‡∏ö Fisher‚ÄìYates
  for (let i = __cueDeck.length - 1; i > 0; i--){
    const j = (Math.random() * (i + 1)) | 0;
    [__cueDeck[i], __cueDeck[j]] = [__cueDeck[j], __cueDeck[i]];
  }
  // ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏û‡πà‡πÉ‡∏ö‡πÅ‡∏£‡∏Å‡∏ä‡∏ô __lastCue (‡∏à‡∏∞‡∏î‡∏π‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ã‡πâ‡∏≥)
  if (__cueDeck.length && __cueDeck[0] === __lastCue){
    const k = (__cueDeck.length > 1) ? 1 : 0;
    [__cueDeck[0], __cueDeck[k]] = [__cueDeck[k], __cueDeck[0]];
  }
}

// ‡∏´‡∏¢‡∏¥‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î 1 ‡πÉ‡∏ö‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡πá‡∏Ñ (‡∏´‡∏°‡∏î‡∏Å‡πá‡∏™‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà)
function drawCueFromDeck(){
  if (!__cueDeck.length) refillCueDeck();
  const id = __cueDeck.shift();
  __lastCue = id;
  return POST_CUES.find(c => c.id === id) || POST_CUES[0];
}


// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡∏£‡∏≠‡πÑ‡∏õ‡∏ï‡πà‡∏≠" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏∏‡πà‡∏°‡∏ó‡πà‡∏≤/‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏π‡∏õ
function selectRandomPostCue(){
  const pick = drawCueFromDeck(); // ‚úÖ ‡πÉ‡∏ä‡πâ‡πÄ‡∏î‡πá‡∏Ñ‡πÅ‡∏ó‡∏ô‡∏™‡∏∏‡πà‡∏° Math.random ‡∏ï‡∏£‡∏á ‡πÜ
  window.__currentPostGesture = pick.id;

  if (postCue){
    postCue.src = pick.img;
    postCue.alt = pick.desc || '‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏ï‡πà‡∏≠';

    // ‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á (‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤) ‚Äî ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞‡∏Å‡∏•‡∏≤‡∏á
    const sideClass = (Math.random() < 0.5) ? 'slot-left' : 'slot-right';
    postCue.classList.remove('slot-left','slot-right');
    postCue.classList.add(sideClass);
  }
}

fastNext?.addEventListener('click', ()=>{
  if (ended || !awaitingContinue) return;
  continueToNextWithDelay();
});

qDecor?.addEventListener('click', ()=>{
  if (ended || !awaitingContinue) return;
  continueToNextWithDelay();
});


function positionDecorUnderQuestion(){
  if(!qDecor) return;
  const r = qBox.getBoundingClientRect();
  const offsetX = parseFloat(
    getComputedStyle(document.documentElement).getPropertyValue('--decor-offset-x')
      || '0'
  ) || 0;

  // ‡∏ß‡∏≤‡∏á‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏£‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
  const centerX = r.left + (r.width/2) + offsetX;
  // ‡πÉ‡∏ä‡πâ left ‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏£‡∏¥‡∏á (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ transform ‡∏≠‡∏µ‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥)
  qDecor.style.transform = 'translateX(0)';
  qDecor.style.left = Math.round(centerX - (qDecor.offsetWidth/2)) + 'px';
  // bottom ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ CSS ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
}

function syncFastNextUI(){
  if (awaitingContinue && !ended){
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≠ ‚Üí ‡∏™‡∏∏‡πà‡∏°‡∏ó‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏π‡∏õ
    if (!window.__cueActive){
      window.__cueActive = true;
      selectRandomPostCue();     // ‚Üê ‡∏™‡∏∏‡πà‡∏° post2‚Äìpost6 (‡∏£‡∏ß‡∏° post1 ‡πÄ‡∏î‡∏¥‡∏°)
    }
    fastNext?.classList.add('show','arm-next');
    qDecor?.classList.add('arm-next');
    postCue?.classList.add('show');
  }else{
    window.__cueActive = false;
    window.__currentPostGesture = null;     // ‚Üê ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏¢‡∏π‡πà
    fastNext?.classList.remove('show','arm-next');
    qDecor?.classList.remove('arm-next');
    postCue?.classList.remove('show');
postCue?.classList.remove('slot-left','slot-right'); // ‡∏•‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤
    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ auto-skip ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏£‡∏≠
if (__postAutoSkipTimer){ 
  clearTimeout(__postAutoSkipTimer); 
  __postAutoSkipTimer = null; 
}
  }
}

window.addEventListener('resize', positionDecorUnderQuestion);
window.addEventListener('load', positionDecorUnderQuestion);
const qImg = document.getElementById('qImg');
const overlay = document.getElementById('overlay');
const finalScoreEl = document.getElementById('finalScore');
const restartBtn = document.getElementById('restartBtn');
const selectLevelBtn = document.getElementById('selectLevelBtn');
const pauseBtn = document.getElementById('pauseBtn');
const goldWrap = document.getElementById('goldWrap');
const clockEl = document.getElementById('clock');


// ‡πÄ‡∏£‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏û‡∏∏‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏ã‡πâ‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏ß
function boostQuestionOutFast(ms=280){
  const span = qBox.querySelector('.mq');
  if(!span) return;

  const cs = getComputedStyle(span);
  let tx = 0;
  const m = cs.transform || cs.webkitTransform || 'none';
  if (m && m !== 'none') {
    const mm = m.match(/matrix\(([^)]+)\)/);
    if (mm) {
      const parts = mm[1].split(',').map(parseFloat);
      tx = parts[4] || 0; // a,b,c,d, tx, ty
    }
  }

  span.style.animation = 'none';
  span.style.willChange = 'transform, opacity';
  span.style.transform = `translateX(${tx}px)`;
  span.getBoundingClientRect(); // reflow

  const r  = span.getBoundingClientRect();
  const pr = qBox.getBoundingClientRect();
  const delta = (pr.left - r.right) - 20; // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏¢‡∏ã‡πâ‡∏≤‡∏¢ 20px

  span.style.transition = `transform ${ms}ms linear, opacity ${ms}ms linear`;
  span.style.transform  = `translateX(${tx + delta}px)`;
  span.style.opacity    = '0.2';

  span.addEventListener('transitionend', () => { span.remove(); }, { once:true });
}


// ‡πÄ‡∏™‡∏µ‡∏¢‡∏á
const hitSound = document.getElementById('hitSound');
const winSound = document.getElementById('winSound');
const bgm = document.getElementById('bgm');
const selectSound = document.getElementById('selectSound');
const wrongSound = document.getElementById('wrongSound');
const beltSound  = document.getElementById('beltSound');
const VOL_BGM   = 0.35;
const VOL_SELECT= 1.70;
const VOL_HIT   = 0.60;
const VOL_WIN   = 0.90;
const VOL_WRONG = 0.40;
const VOL_BELT  = 0.80;

/* ====== Belt Sound: bank + no-repeat deck ====== */
// ‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå image/ 
// (‡πÉ‡∏™‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏µ‡πà‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πá‡πÑ‡∏î‡πâ)
const BELT_SRC_BANK = [
  'image/belt1.mp3','image/belt2.mp3','image/belt3.mp3','image/belt4.mp3','image/belt5.mp3','image/belt6.mp3','image/belt7.mp3','image/belt8.mp3','image/belt9.mp3',
    'image/belt10.mp3','image/belt11.mp3','image/belt12.mp3','image/belt13.mp3','image/belt14.mp3','image/belt15.mp3','image/belt16.mp3','image/belt17.mp3','image/belt18.mp3'
].filter(Boolean);

// ‡πÄ‡∏î‡πá‡∏Ñ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏∏‡πà‡∏°‡∏ã‡πâ‡∏≥‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô (Fisher‚ÄìYates + ‡∏Å‡∏±‡∏ô‡πÉ‡∏ö‡πÅ‡∏£‡∏Å‡∏ä‡∏ô‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
let __beltDeck = [];
let __lastBelt = null;

function refillBeltDeck(){
  __beltDeck = BELT_SRC_BANK.slice();
  for (let i = __beltDeck.length - 1; i > 0; i--){
    const j = (Math.random() * (i + 1)) | 0;
    [__beltDeck[i], __beltDeck[j]] = [__beltDeck[j], __beltDeck[i]];
  }
  if (__beltDeck.length > 1 && __beltDeck[0] === __lastBelt){
    [__beltDeck[0], __beltDeck[1]] = [__beltDeck[1], __beltDeck[0]];
  }
}

function nextBeltSrc(){
  if (!BELT_SRC_BANK.length) return 'image/belt.mp3'; // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á bank
  if (!__beltDeck.length) refillBeltDeck();
  const pick = __beltDeck.shift();
  __lastBelt = pick;
  return pick || 'image/belt.mp3';
}

/* ‡∏û‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á belt ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏≤ ‡πÜ */
function preloadBeltSounds(){
  try{
    BELT_SRC_BANK.forEach(src=>{
      const a = new Audio();
      a.preload = 'auto';
      a.src = src;
    });
  }catch(_){}
}


// ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏û‡∏±‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£ clamp 0..1
function v(x){ x=Number(x); return (isFinite(x)? Math.max(0,Math.min(1,x)) : 1); }

if (bgm)         bgm.volume         = v(VOL_BGM);
if (selectSound) selectSound.volume = v(VOL_SELECT);
if (hitSound)    hitSound.volume    = v(VOL_HIT);
if (winSound)    winSound.volume    = v(VOL_WIN);
if (wrongSound)  wrongSound.volume  = v(VOL_WRONG);
if (beltSound)   beltSound.volume   = v(VOL_BELT);

/* ===== Bank: ‡∏£‡∏π‡∏õ‡∏ß‡∏±‡∏™‡∏î‡∏∏ =====
   ‡πÅ‡∏Å‡πâ path ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ (‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡πá‡πÑ‡∏î‡πâ) */
const MATERIAL_IMG = {};

const rand=(min,max)=>Math.floor(Math.random()*(max-min+1))+min;
const pick=(arr)=>arr[rand(0,arr.length-1)];
const shuffle=(arr)=>{ const A=arr.slice(); for(let i=A.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [A[i],A[j]]=[A[j],A[i]] } return A };

function isGlobalMuted(){ const a=document.querySelector('audio'); return !!a && a.muted===true }
function playSfx(el,vol){ try{ const n=el?.cloneNode(true); if(!n)return; n.volume=(typeof vol==='number')?Math.max(0,Math.min(1,vol)):(el.volume??1); n.muted=isGlobalMuted(); n.play?.(); }catch(_){} }
function renderGold(n){ goldWrap.innerHTML = `<span class="num">${Number(n)||0}</span>`; }

// ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡∏ö‡∏ô HUD
let clockUIItv=null, clockState='idle';
function fmtClock(ms){ const t=Math.max(0,Math.ceil(ms/1000)); const m=String(Math.floor(t/60)).padStart(2,'0'); const s=String(t%60).padStart(2,'0'); return m+':'+s; }
function renderClock(){ const ms=(clockState==='run')?Math.max(0,(gameEndAt-performance.now())):remainingMs; clockEl.textContent=fmtClock(ms); }
function startClockUI(){ clockState='run'; if(!clockUIItv) clockUIItv=setInterval(renderClock,250); renderClock(); }
function pauseClockUI(){ clockState='pause'; if(clockUIItv){ clearInterval(clockUIItv); clockUIItv=null; } renderClock(); }
function stopClockUI(){ clockState='end'; if(clockUIItv){ clearInterval(clockUIItv); clockUIItv=null; } renderClock(); }
function resetClockUI(){ clockState='idle'; if(clockUIItv){ clearInterval(clockUIItv); clockUIItv=null; } clockEl.textContent=fmtClock(GAME_DURATION_MS); }


// ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡∏≠‡∏¢ -> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡πÅ‡∏ü‡∏•‡∏ä‡∏ó‡∏±‡πâ‡∏á‡∏à‡∏≠" 0.7 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
let __flashTimer = null;
function flyScore(ok){
  const ov = document.getElementById('flashOverlay');
  if(!ov) return;
  // ‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏ñ‡∏π‡∏Å/‡∏ú‡∏¥‡∏î
  ov.style.background = ok ? 'var(--flash-ok)' : 'var(--flash-bad)';

  ov.classList.add('on');
  // ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô 0.7 ‡∏ß‡∏¥ (‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ)
  clearTimeout(__flashTimer);
  __flashTimer = setTimeout(()=> ov.classList.remove('on'), 400);
}

const LEVEL1_BINDINGS = {};
const LEVEL2_BINDINGS = {};
const OBJECTS = [];

// ===== ‡∏î‡πà‡∏≤‡∏ô 5‚Äì7: POOL ‡∏Ñ‡∏≥‡∏ñ‡∏π‡∏Å/‡∏Ñ‡∏≥‡∏ú‡∏¥‡∏î (‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏ô‡∏ß‡∏á‡∏Å‡∏•‡∏°) =====
const LEVEL5_WRONG = [
  "a","b","d","e","f","g","h","i","j","k","l","m","n","p","q","r","t","u","y"
];
const LEVEL5_CORRECT = [
  "A","B","D","E","F","G","H","I","J","K","L","M","N","P","Q","R",
  "T","U","Y"
];

const LEVEL6_CORRECT = [  "a","b","d","e","f","g","h","i","j","k","l","m","n","p","q","r",
  "t","u","y"];

const LEVEL6_WRONG   = [  "A","B","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R",
  "T","U","Y"];

const LEVEL7_CORRECT = [
  "1-one","2-two","3-three","4-four","5-five","6-six","7-seven",
  "8-eight","9-nine","10-ten","11-eleven","12-twelve","13-thirteen",
  "14-fourteen","15-fifteen","16-sixteen","17-seventeen","18-eighteen",
  "19-nineteen","20-twenty"
];

const LEVEL7_WRONG   = [
  "17-seven","10-eleven","7-six","20-twelve","4-fourteen","2-three","4-five","19-fifteen","10-nine","8-eighteen",
  "6-two","10-one","6-sixteen","2-ten","30-thirteen","12-twenty","5-four","9-eight","16-seventeen","12-nineteen",
  "11-thirteen","6-five","3-twenty","4-eight","5-twelve","6-one","17-sixteen","13-fourteen","15-seventeen","10-three",
  "10-fifteen","3-four","18-two","12-eleven","14-nine","16-seventeen","15-twenty","5-seven","20-ten","9-six",
  "91-nineteen","4-three","16-fourteen","7-five","11-seven","6-thirteen","7-one","11-twenty","2-twelve","19-sixteen",
  "2-four","12-fifteen","18-two","13-eighteen","14-nine","6-eight","17-eleven","8-six","19-seventeen","11-ten",
  "1-fourteen","2-two","3-ten","4-nine","5-five","6-seventeen","7-twelve","8-one","8-nineteen","10-six"
];

const LEVEL3_BANK = [
  {
    questionText: '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏Ç‡πá‡∏á',
    answers: [],
    correctIndices:  [],
        scoreByIndex: {}
  },

  {
    questionText: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô',
    answers: [],
    correctIndices: [],
       scoreByIndex:{}
  },

   {
    questionText: '‡∏ô‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô',
    answers: [
{ type:'material', name:'‡πÑ‡∏°‡πâ', caption:'‡πÑ‡∏°‡πâ', img: MATERIAL_IMG['‡πÑ‡∏°‡πâ'] },
{ type:'material', name:'‡πÄ‡∏ô‡∏∑‡πâ‡∏≠', caption:'‡πÄ‡∏ô‡∏∑‡πâ‡∏≠', img: MATERIAL_IMG['‡πÄ‡∏ô‡∏∑‡πâ‡∏≠'] },
    ],
    correctIndices: [],
       scoreByIndex:{}
  },

  {
    questionText: '‡∏ô‡∏≥‡πÑ‡∏ü‡∏ü‡πâ‡∏≤',
    answers: [],
    correctIndices: [],
       scoreByIndex:{}
  },

   {
    questionText: '‡∏â‡∏ô‡∏ß‡∏ô‡πÑ‡∏ü‡∏ü‡πâ‡∏≤',
    answers: [],
    correctIndices: [],
       scoreByIndex:{}
  },

   {
    questionText: '‡∏â‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô',
    answers: [
{ type:'material', name:'‡πÑ‡∏°‡πâ', caption:'‡πÑ‡∏°‡πâ', img: MATERIAL_IMG['‡πÑ‡∏°‡πâ'] },
    ],
    correctIndices: [],
       scoreByIndex:{}
  },
];

const ANSWER_CHOICES = [];
const M = (name, correctIndices, scoreByIndex) => ({
  questionText: name,
  answers: ANSWER_CHOICES,
  correctIndices,
  scoreByIndex
});

const LEVEL4_BANK = [];
const MATERIAL_ORDER = [];

function drawLevel3(){ 
  const q = pick(LEVEL3_BANK);

  const allChoices = MATERIAL_ORDER.map(name => ({
    type: 'material',
    name, caption: name, img: MATERIAL_IMG[name]
  }));
  const maxIndex = allChoices.length - 1;

  let correctGlobal = Array.isArray(q.correctIndices)
    ? [...new Set(q.correctIndices.filter(i => Number.isInteger(i) && i>=0 && i<=maxIndex))]
    : [];

  if (correctGlobal.length === 0) {
    correctGlobal = [Math.floor(Math.random()*allChoices.length)];
  }

  const SAMPLE_SIZE = 3;
  const selected = new Set([ pick(correctGlobal) ]);
  let slotsLeft = SAMPLE_SIZE - selected.size;
  const extraMax  = Math.max(0, slotsLeft - 1);         // ‚Üê ‡πÄ‡∏ß‡πâ‡∏ô 1 ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏≠‡∏Å
  const extraTake = rand(0, extraMax);                  // 0..(slotsLeft-1)
  shuffle(correctGlobal.filter(i => !selected.has(i)))
    .slice(0, extraTake)
    .forEach(i => selected.add(i));

  // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 3 ‡∏õ‡∏∏‡πà‡∏°
  slotsLeft = SAMPLE_SIZE - selected.size;
  const allIncorrect = [];
  for (let i=0;i<=maxIndex;i++){ if(!correctGlobal.includes(i)) allIncorrect.push(i); }
  shuffle(allIncorrect).slice(0, slotsLeft).forEach(i => selected.add(i));
  if ([...selected].every(i => correctGlobal.includes(i)) && allIncorrect.length){
    const toReplace = pick([...selected]);
    selected.delete(toReplace);
    selected.add(pick(allIncorrect));
  }

  const idxs = shuffle([...selected]);
  const answers = idxs.map(i => allChoices[i]);
  const correctIndices = idxs.map((i,pos)=> correctGlobal.includes(i) ? pos : -1).filter(pos=>pos!==-1);

  // map ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (global ‚Üí local)
  const scoreMapLocal = {};
  if (q.scoreByIndex && typeof q.scoreByIndex==='object'){
    for (const [gStr, ptsRaw] of Object.entries(q.scoreByIndex)){
      const g = Number(gStr);
      const local = idxs.indexOf(g);
      if (local !== -1){
        const pts = Number(ptsRaw);
        scoreMapLocal[local] = Number.isFinite(pts) ? pts : 1;
      }
    }
  }

  return { questionText: q.questionText, answers, correctIndices, scoreMap: scoreMapLocal };
}


function drawLevel4(){
  const q = pick(LEVEL4_BANK);

  // ‚òÖ ‡∏î‡πà‡∏≤‡∏ô 4 ‡πÉ‡∏ä‡πâ‡∏ä‡πâ‡∏≠‡∏¢‡∏™‡πå ‚Äú‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏¥‡∏¢‡∏≤‡∏°‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‚Äù ‡πÑ‡∏°‡πà‡πÑ‡∏õ‡∏î‡∏∂‡∏á MATERIAL_ORDER
  const allChoices = q.answers;
  const maxIndex = allChoices.length - 1;

  let correctGlobal = Array.isArray(q.correctIndices)
    ? [...new Set(q.correctIndices.filter(i => Number.isInteger(i) && i>=0 && i<=maxIndex))]
    : [];

  if (correctGlobal.length === 0) correctGlobal = [Math.floor(Math.random()*allChoices.length)];

  const SAMPLE_SIZE = 3;

  // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å 1 ‡∏≠‡∏±‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
  const selected = new Set([ pick(correctGlobal) ]);

  // ‚òÖ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡∏ï‡∏±‡∏ß‡∏ú‡∏¥‡∏î" ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏≠‡∏±‡∏ô
  let slotsLeft = SAMPLE_SIZE - selected.size;
  const extraMax  = Math.max(0, slotsLeft - 1);
  const extraTake = rand(0, extraMax);
  shuffle(correctGlobal.filter(i => !selected.has(i)))
    .slice(0, extraTake)
    .forEach(i => selected.add(i));

  // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö
  slotsLeft = SAMPLE_SIZE - selected.size;
  const allIncorrect = [];
  for (let i=0;i<=maxIndex;i++){ if(!correctGlobal.includes(i)) allIncorrect.push(i); }
  shuffle(allIncorrect).slice(0, slotsLeft).forEach(i => selected.add(i));

  // ‚òÖ SAFETY
  if ([...selected].every(i => correctGlobal.includes(i)) && allIncorrect.length){
    const toReplace = pick([...selected]);
    selected.delete(toReplace);
    selected.add(pick(allIncorrect));
  }

  const idxs = shuffle([...selected]);
  const answers = idxs.map(i => allChoices[i]);
  const correctIndices = idxs.map((i,pos)=> correctGlobal.includes(i) ? pos : -1).filter(pos=>pos!==-1);

  // map ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (global ‚Üí local)
  const scoreMapLocal = {};
  if (q.scoreByIndex && typeof q.scoreByIndex==='object'){
    for (const [gStr, ptsRaw] of Object.entries(q.scoreByIndex)){
      const g = Number(gStr);
      const local = idxs.indexOf(g);
      if (local !== -1){
        const pts = Number(ptsRaw);
        scoreMapLocal[local] = Number.isFinite(pts) ? pts : 1;
      }
    }
  }

  return { questionText: q.questionText, answers, correctIndices, scoreMap: scoreMapLocal };
}

/* ===== ‡∏î‡πà‡∏≤‡∏ô 5‚Äì7: ‡πÇ‡∏´‡∏°‡∏î "‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πâ‡∏ß‡∏ô 4 ‡∏ß‡∏á" ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ===== */
function drawLevelTextOnly(correctPool, wrongPool){
  // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ñ‡∏π‡∏Å 2 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ ‡∏à‡∏∞‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ)
  const candsCorrect = shuffle(correctPool).slice(0, Math.min(2, correctPool.length));
  const candsWrong   = shuffle(wrongPool).slice(0, Math.min(2, wrongPool.length));
  // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ù‡∏±‡πà‡∏á‡πÑ‡∏°‡πà‡∏û‡∏≠ ‚Üí ‡∏î‡∏∂‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏≠‡∏µ‡∏Å‡∏ù‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 4
  let labels = [...candsCorrect, ...candsWrong];
  if (labels.length < 4){
    const need = 4 - labels.length;
    const filler = shuffle([...correctPool, ...wrongPool]).filter(v=>!labels.includes(v)).slice(0, need);
    labels.push(...filler);
  }
  labels = labels.slice(0,4);
  const idxs = shuffle([0,1,2,3]);
  const shuffled = idxs.map(i=>labels[i%labels.length]);
  // ‡∏ó‡∏≥‡∏ä‡∏∏‡∏î index ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà "‡∏ñ‡∏π‡∏Å"
  const okSet = new Set();
  shuffled.forEach((txt,i)=>{
    if (candsCorrect.includes(txt)) okSet.add(i);
  });
  // ‡∏ñ‡πâ‡∏≤‡∏ö‡∏±‡∏á‡πÄ‡∏≠‡∏¥‡∏ç‡∏ñ‡∏π‡∏Å‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á 2 ‚Üí ‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 2 ‡πÇ‡∏î‡∏¢‡∏¢‡πâ‡∏≤‡∏¢‡∏ö‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡∏ñ‡∏π‡∏Å
  while (okSet.size < 2){
    const i = rand(0,3);
    okSet.add(i);
  }
  return { labels: shuffled, okSet };
}

// ‡∏î‡πà‡∏≤‡∏ô 1: ‡∏ß‡∏±‡∏™‡∏î‡∏∏ -> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏ (‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡∏°‡∏≤‡∏à‡∏≤‡∏Å LEVEL1_BINDINGS, ‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏≠‡∏Å‡∏à‡∏≤‡∏Å OBJECTS)
function drawLevel1(){
  const keys = Object.keys(LEVEL1_BINDINGS);
  const material = pick(keys);

  const correct = pick(LEVEL1_BINDINGS[material]);

  // ‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏≠‡∏∑‡πà‡∏ô
  const fakes = shuffle(
      keys.filter(k => k !== material)
  ).slice(0,2).map(k => pick(LEVEL1_BINDINGS[k]));

  const candidates = shuffle([
      { ...correct, _ok:true },
      ...fakes
  ]);
  const correctIndex = candidates.findIndex(c => c._ok);

  return {
    questionText: material,
    answers: candidates.map(c => ({
      type: 'object',
      name: c.caption,
      img:  c.img,
      tag:  material,
      caption: c.caption
    })),
    correctIndex
  };
}


// ‡∏î‡πà‡∏≤‡∏ô 2: ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏ -> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏ (‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡∏°‡∏≤‡∏à‡∏≤‡∏Å LEVEL2_BINDINGS, ‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏≠‡∏Å‡∏à‡∏≤‡∏Å MATERIAL_IMG ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ)
function drawLevel2(){
  const obj = pick(OBJECTS);
  const question = obj.name;            // ‡πÇ‡∏à‡∏ó‡∏¢‡πå = ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏
  const correctMat = obj.material;

  // ‡∏£‡∏π‡∏õ/‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡∏ô "‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á" ‡∏à‡∏≤‡∏Å‡πÅ‡∏°‡∏õ‡∏õ‡∏¥‡∏á (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏ô‡πÅ‡∏°‡∏õ ‡πÉ‡∏´‡πâ fallback ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏ß‡∏±‡∏™‡∏î‡∏∏ + caption=‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏™‡∏î‡∏∏)
  let correct = LEVEL2_BINDINGS[question];
  if(!correct){
    correct = { img: MATERIAL_IMG[correctMat], caption: correctMat };
  }

  // ‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏≠‡∏∑‡πà‡∏ô ‡πÜ (‡πÉ‡∏ä‡πâ MATERIAL_IMG) 2 ‡∏ä‡∏¥‡πâ‡∏ô
  const mats = Object.keys(MATERIAL_IMG).filter(m=>m!==correctMat);
  const distract = shuffle(mats).slice(0,2).map(m=>({ img: MATERIAL_IMG[m], caption: m }));

  // ‡∏£‡∏ß‡∏° + ‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
  const candidates = shuffle([ {img:correct.img, caption:correct.caption, _ok:true}, ...distract ]);
  const correctIndex = candidates.findIndex(c=>c._ok);

  return {
    questionText: question,             // ‡πÇ‡∏à‡∏ó‡∏¢‡πå = ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏ (‡πÑ‡∏õ‡πÇ‡∏ä‡∏ß‡πå‡∏ß‡∏¥‡πà‡∏á‡∏•‡πà‡∏≤‡∏á)
    answers: candidates.map(c=>({
      type:'material',
      name: c.caption,                  // ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô alt ‡∏î‡πâ‡∏ß‡∏¢
      img:  c.img,
      tag:  c.caption,                  // ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÑ‡∏ß‡πâ
      caption: c.caption                // ‚Üê ‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡∏ô‡πÉ‡∏ï‡πâ‡∏£‡∏π‡∏õ (‡πÑ‡∏°‡πà‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°)
    })),
    correctIndex
  };
}


// =========================
// ‡∏û‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö fail ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏ï‡πà‡∏≠)
// =========================
const __imgMemo = new Map();
function preloadOne(src, timeout=8000, tries=2){
  if(!src) return Promise.resolve(false);
  if(__imgMemo.has(src)) return __imgMemo.get(src);
  const runner = (attempt)=> new Promise(resolve=>{
    const img = new Image(); let done=false;
    const settle = ok=>{ if(done) return; done=true; resolve(ok); };
    const t = setTimeout(()=>{ img.onload=img.onerror=null; settle(false) }, timeout);
    img.onload = ()=>{ clearTimeout(t); settle(true) };
    img.onerror= ()=>{ clearTimeout(t); (attempt<tries)? setTimeout(()=>runner(attempt+1).then(resolve), 250): settle(false) };
    img.decoding='async'; img.loading='eager'; img.referrerPolicy='no-referrer'; img.src=src;
  });
  const p=runner(0); __imgMemo.set(src,p); return p;
}
async function preloadInBatches(urls,batch=16,onProgress=()=>{}){
  const list=[...new Set(urls.filter(Boolean))]; let done=0;
  for(let i=0;i<list.length;i+=batch){
    const chunk=list.slice(i,i+batch);
    await Promise.allSettled(chunk.map(u=>preloadOne(u)));
    done+=chunk.length; onProgress(Math.round((done/list.length)*100));
    await new Promise(r=>setTimeout(r,60));
  }
}

function collectAllGameImages(){
  const urls=[];
  Object.values(LEVEL1_BINDINGS).forEach(arr =>
      arr.forEach(item => urls.push(item.img))
  );
  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á/‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡πÅ‡∏ö‡∏ö‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏£‡∏ö ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ ‚Ä¶
  urls.push(
    "image/background2.png","image/banner2.png","image/welcome.png","image/guide.png","image/button1.png","image/button2.png","image/post1.png", 
    "image/post2.png","image/post3.png","image/post4.png", "image/post5.png","image/post6.png","image/post7.png","image/post8.png", "image/post9.png",
       "image/post10.png","image/post11.png","image/post12.png","image/post13.png","image/post14.png","image/post15.png","image/post16.png","image/post17.png","image/post19.png"
  );
  try{
    POST_CUES.forEach(c => { if (c?.img) urls.push(c.img); });
  }catch(_){
    // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ POST_CUES ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® (‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ô‡∏µ‡πâ)
  }
  return urls.map(p=>new URL(p,location.href).href);
}

function bindPreloadProgress(){
  const bar  = document.getElementById('preloadBar');
  const text = document.getElementById('preloadText');
  return (pct)=>{ if(bar) bar.style.width=pct+'%'; if(text) text.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶ '+pct+'%'; };
}
async function runGlobalPreload(){
  const urls=collectAllGameImages(); const progress=bindPreloadProgress();
  try{ await preloadInBatches(urls,18,(p)=>progress(p)) }finally{
    document.getElementById('preloadOverlay')?.remove();
    window.__ALL_IMAGES_READY__=true;
  }
}
window.addEventListener('load', runGlobalPreload);
window.addEventListener('load', preloadBeltSounds);


// ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°/‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
function clearChoices(){
  while(choicesRow.firstChild) choicesRow.removeChild(choicesRow.firstChild);
}

// ==== STOP marquee safely (‡∏Ü‡πà‡∏≤‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô + ‡∏Å‡∏±‡∏ô callback ‡πÄ‡∏Å‡πà‡∏≤) ====
let __mqToken = 0;
function stopMarquee(){
  __mqToken++; // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ callback ‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏°‡∏Ü‡∏∞
  const span = qBox.querySelector('.mq');
  if (!span) return;
  span.style.animation = 'none';
  span.style.transition = 'none';
  span.style.opacity = '0';
  span.remove();
}

// ==== ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏¢‡πà‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ó‡∏∏‡∏Å‡∏ä‡πâ‡∏≠‡∏¢‡∏™‡πå ====
function vanishAllChoices(ms = 420){
  choicesRow.style.setProperty('--vanish-ms', (ms|0)+'ms');
  const wraps = [...choicesRow.querySelectorAll('.option-wrap')];
  if (!wraps.length){ clearChoices(); return; }

  // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏•‡∏≤‡∏™‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏ä‡∏ô transition/animation ‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏£‡∏µ‡πÇ‡∏ü‡∏•‡∏ß‡πå‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏™‡πà .is-vanish
  wraps.forEach(w=>{
    w.classList.remove('chosen','faded','is-chosen','is-faded');
    const c = w.querySelector('.option.circle');
    if (c){
      c.classList.remove('pre-in','go-in','pick-pop','slide-up-out');
      // ‡∏£‡∏µ‡πÇ‡∏ü‡∏•‡∏ß‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ô‡πà‡πÜ
      void c.offsetWidth;
    }
  });

  // ‡πÉ‡∏™‡πà‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô ‚Äú‡∏¢‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏≤‡∏¢‚Äù ‡πÉ‡∏´‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á
  requestAnimationFrame(()=>{
    wraps.forEach(w=> w.classList.add('is-vanish'));
  });

  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡∏à‡∏ö
  setTimeout(()=>{ clearChoices(); }, ms);
}


function spawnRow3(answers, correctIndex, questionText){
  clearChoices();
  // ‡∏û‡∏≤‡πÄ‡∏•‡∏ï‡∏Ç‡∏≠‡∏ö‡∏ß‡∏á‡∏Å‡∏•‡∏° (‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏£‡∏≠‡∏ö)
  const ringGrads = pickGradients(answers.length);


  answers.forEach((ans,idx)=>{
    // ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏£‡∏≠‡∏ö: ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á "‡∏ß‡∏á‡∏Å‡∏•‡∏°" + "‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡∏ô‡πÉ‡∏ï‡πâ‡∏£‡∏π‡∏õ"
    const wrap = document.createElement('div');
    wrap.className = 'option-wrap';

    // ‡∏õ‡∏∏‡πà‡∏°‡∏ß‡∏á‡∏Å‡∏•‡∏° (‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°)
    const el = document.createElement('div');
    el.className = 'option circle pre-in';
    el.style.setProperty('--ring', ringGrads[idx]);


    const im = document.createElement('img');
    im.alt = (ans.type==='object' ? '‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏' : '‡∏ß‡∏±‡∏™‡∏î‡∏∏') + ' : ' + (ans.name||'');
    im.src = ans.img || '';
    el.appendChild(im);

    // dataset ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏ñ‡∏π‡∏Å/‡∏ú‡∏¥‡∏î
    el.dataset.correct = String(idx===correctIndex);
    el.dataset.index = String(idx);
    el.addEventListener('click', ()=>tryAnswer(el));

    // ‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡∏ô‡πÉ‡∏ï‡πâ‡∏£‡∏π‡∏õ (‡πÑ‡∏°‡πà‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°)
    const cap = document.createElement('div');
    cap.className = 'opt-cap';
    cap.textContent = String(ans.caption || ans.name || '');

    // ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô
    wrap.appendChild(el);
    wrap.appendChild(cap);
    choicesRow.appendChild(wrap);

    // ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ü‡∏£‡∏°‡∏ó‡∏µ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°
    setTimeout(()=>{ el.classList.add('go-in'); }, 80*idx);
  });

  // ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏á‡∏à‡∏≠‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
  setQuestionMarquee(String(questionText || ''));
}

// ===== ‡∏î‡πà‡∏≤‡∏ô 3: ‡∏™‡∏£‡πâ‡∏≤‡∏á 3 ‡∏õ‡∏∏‡πà‡∏° + ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å =====
function spawnRow3Multi(answers, correctIndices, questionText, scoreMap = {}){
  clearChoices();
  const ringGrads = pickGradients(answers.length);

  __multiCorrectSet = new Set(correctIndices);
  remainingCorrect = new Set(correctIndices);
    
  // ‚òÖ ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡πà‡∏≠ index ‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏Å‡∏î
  window.__L3_CURRENT_ANSWERS = answers;
  window.__L3_SCORE_MAP = scoreMap || {};

  answers.forEach((ans, idx)=>{
    const wrap = document.createElement('div');
    wrap.className = 'option-wrap';
    const el = document.createElement('div');
    el.className = 'option circle pre-in';
    el.style.setProperty('--ring', ringGrads[idx]);
    const im = document.createElement('img');
    im.alt = (ans.type==='object' ? '‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏' : '‡∏ß‡∏±‡∏™‡∏î‡∏∏') + ' : ' + (ans.name||'');
    im.src = ans.img || '';
    el.appendChild(im);

    el.dataset.index = String(idx);
    el.addEventListener('click', ()=>tryAnswerMulti(el));

    const cap = document.createElement('div');
    cap.className = 'opt-cap';
    cap.textContent = String(ans.caption || ans.name || '');

    wrap.appendChild(el);
    wrap.appendChild(cap);
    choicesRow.appendChild(wrap);

    setTimeout(()=>{ el.classList.add('go-in'); }, 80*idx);
  });

  setQuestionMarquee(String(questionText || ''));
}

function gradientPairs(){
  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏≤‡πÄ‡∏•‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏¢‡∏≠‡∏∞‡πÅ‡∏•‡∏∞‡∏™‡∏î‡∏Ç‡∏∂‡πâ‡∏ô (‡πÅ‡∏Å‡πâ/‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡πÉ‡∏à)
  return [
    ['#ef4444','#f59e0b'], ['#f97316','#eab308'], ['#22c55e','#84cc16'],
    ['#10b981','#14b8a6'], ['#06b6d4','#3b82f6'], ['#60a5fa','#8b5cf6'],
    ['#a855f7','#ec4899'], ['#f43f5e','#fb7185'], ['#0ea5e9','#22d3ee'],
    ['#34d399','#4ade80'], ['#f59e0b','#fde047'], ['#bbf7d0','#34d399'],
    ['#7c3aed','#22d3ee'], ['#f472b6','#fb7185'], ['#64748b','#94a3b8']
  ];
}
function pickGradients(n){
  const picked = shuffle(gradientPairs()).slice(0, Math.max(1, n));
  return picked.map(([a,b]) => `linear-gradient(135deg, ${a}, ${b})`);
}


/* ===== ‡∏™‡∏£‡πâ‡∏≤‡∏á 4 ‡∏ß‡∏á‡∏Å‡∏•‡∏° (‡∏ã‡πâ‡∏≤‡∏¢ 2 / ‡∏Ç‡∏ß‡∏≤ 2) ‚Äî ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πâ‡∏ß‡∏ô =====
   labels: string[4]
   okSet:  Set ‡∏Ç‡∏≠‡∏á index ‡∏ó‡∏µ‡πà "‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á" (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 2)
=============================================================== */
function spawnSideOptions4Text(labels, okSet){
  const side = document.getElementById('sideChoices');
  if(!side) return;

  // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Ç‡∏≠‡∏á‡πÇ‡∏´‡∏°‡∏î 4 ‡∏ß‡∏á
  __sideChosen.clear();
  __sideRequiredPicks = 2;       // ‚Üê ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 2 ‡∏ß‡∏á‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö
  __sideOkSet = new Set(okSet);  // ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏Ñ‡∏¥‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô/‡∏à‡∏ö‡∏£‡∏≠‡∏ö

  side.innerHTML = '';

  // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á 4 ‡∏à‡∏∏‡∏î‡∏ö‡∏ô‡∏à‡∏≠ (‡∏ã‡πâ‡∏≤‡∏¢‡∏ö‡∏ô/‡∏ã‡πâ‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏á/‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô/‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á)
  const posClasses = ['bubble-LT','bubble-LB','bubble-RT','bubble-RB'];
  const fillGrads = (window.__SIDE_FILL_GRADS = pickGradients(labels.length));
  labels.forEach((txt, idx)=>{
    // ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏£‡∏≠‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏á (‡πÉ‡∏ä‡πâ‡∏Ñ‡∏•‡∏≤‡∏™‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á + ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤)
    const wrap = document.createElement('div');
    wrap.className = `bubble-pos ${posClasses[idx]||posClasses[0]} bubble-pre`;
    const bub = document.createElement('div');
    bub.className = 'option circle text-only';
    bub.style.setProperty('--bubble-bg', fillGrads[idx]);
    bub.dataset.index   = String(idx);
    bub.dataset.correct = String(okSet.has(idx));

const label = document.createElement('div');
label.className = 'label';

/* ‡πÅ‡∏ï‡∏Å‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î */
let numPart=null, wordPart=null;
if (/^\d+\-/.test(txt)) {
  const sp = String(txt).split('-', 2);
  numPart  = sp[0];
  wordPart = sp[1];
} else {
  wordPart = String(txt);   // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏µ‡∏î ‚Üí ‡∏°‡∏µ‡πÅ‡∏Ñ‡πà 1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î (‡∏Ñ‡∏≥)
}

if (numPart){
  const ln = document.createElement('div');
  ln.className = 'line-num';
  ln.textContent = numPart;
  label.appendChild(ln);
}
{
  const lw = document.createElement('div');
  lw.className = 'line-word';
  lw.textContent = wordPart;
  label.appendChild(lw);
}

bub.appendChild(label);
wrap.appendChild(bub);
side.appendChild(wrap);

/* fit ‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏ß‡∏á */
requestAnimationFrame(()=> autoFitBubbleLabel(bub));

    bub.addEventListener('click', ()=> tryAnswerSide4(bub));
    requestAnimationFrame(()=>{
      wrap.classList.remove('bubble-pre');
      wrap.classList.add('bubble-in');
    });
  });

  stopMarquee();
  qBox.textContent = '';
}

/* ‡∏¢‡πà‡∏≠‡∏™‡πÄ‡∏Å‡∏• label ‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏±‡∏ö‡∏ß‡∏á (‡∏Ñ‡∏á‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á-‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô) */
function autoFitBubbleLabel(bub){
  try{
    const label = bub.querySelector('.label');
    if(!label) return;

    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡πÄ‡∏Å‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏î
    bub.style.setProperty('--fit-scale','1');

    // ‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏£‡∏≠‡∏ö‡∏ß‡∏á (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢)
    const p  = 6; // ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö padding-inline:6% ‡πÉ‡∏ô CSS
    const r  = bub.getBoundingClientRect();
    const lw = r.width  * (1 - (p/100)*2);
    const lh = r.height * (1 - 0.10);   // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ö‡∏ô‡∏•‡πà‡∏≤‡∏á ~10%

    const L  = label.getBoundingClientRect();

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏≠‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡πÉ‡∏î ‚Üí ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πÄ‡∏Å‡∏•
    let sx = lw / Math.max(1, L.width);
    let sy = lh / Math.max(1, L.height);
    let s  = Math.min(sx, sy, 1);       // ‡πÑ‡∏°‡πà‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô 1

    // ‡∏Å‡∏±‡∏ô‡∏Ñ‡πà‡∏≤‡πÅ‡∏õ‡∏•‡∏Å ‡πÜ
    if (!isFinite(s) || s <= 0) s = 1;

    bub.style.setProperty('--fit-scale', String(s));
  }catch(_){}
}


function tryAnswerSide4(bub){
  if (ended || !awaitingAnswer) return;

  const idx = Number(bub.dataset.index);
  if (__sideChosen.has(idx)) return;        // ‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏ã‡πâ‡∏≥‡∏ß‡∏á‡πÄ‡∏î‡∏¥‡∏°
  const ok  = (bub.dataset.correct === 'true');
  const wrap = bub.closest('.bubble-pos');
  __sideChosen.add(idx);

  // ‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏•‡∏¥‡∏Å (‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏∏‡πà‡∏á‡∏ß‡∏á‡∏≠‡∏∑‡πà‡∏ô)
  wrap.classList.remove('bubble-in');
  wrap.classList.add('bubble-chosen');
  bub.style.pointerEvents = 'none';         // ‡∏•‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡πâ‡∏≥

  // ‡∏Ñ‡∏¥‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å
  if (ok){
    playSfx(selectSound, VOL_SELECT);
    playSfx(hitSound,    VOL_HIT);
    score += 1;
    flyScore(true);
  }else{
    playSfx(wrongSound,  VOL_WRONG);
    score -= 1;
    flyScore(false);
  }
  renderGold(score);

  if (__sideChosen.size < __sideRequiredPicks){
    return;
  }

  boostQuestionOutFast(240); 
  const all = [...document.querySelectorAll('#sideChoices .bubble-pos')];
  all.forEach(w=>{
    const i = Number(w.querySelector('.option.circle')?.dataset.index ?? -1);
    if (!__sideChosen.has(i)){    
      w.classList.remove('bubble-in');
      w.classList.add('bubble-fade');
    }
  });

  awaitingAnswer = false;
  setTimeout(()=>{
  document.getElementById('sideChoices').innerHTML = '';
  qBox.textContent = '';
  // ‚òÖ ‡∏´‡∏ô‡πà‡∏ß‡∏á‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡πâ‡∏≠‡∏¢‡∏™‡πå ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ä‡πà‡∏ß‡∏á‡πÇ‡∏û‡∏™‡∏ó‡πà‡∏≤
  enterPostPhaseAfterClearDelay();
  }, 520);
}


function tryAnswerMulti(el){
  if (ended || !awaitingAnswer) return;

  const idx  = Number(el.dataset.index);
  const ok   = __multiCorrectSet.has(idx);
  const wrap = el.closest('.option-wrap');

  // ‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏ã‡πâ‡∏≥ + ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  if (el.classList.contains('answered')) return;
  el.classList.add('answered');
  awaitingAnswer = false;

  // ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÄ‡∏•‡∏∑‡∏≠‡∏Å + ‡πÄ‡∏£‡πà‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏≠‡∏≠‡∏Å‡∏ã‡πâ‡∏≤‡∏¢ + ‡πÄ‡∏ü‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏∑‡πà‡∏ô
  boostQuestionOutFast(280);
  [...choicesRow.querySelectorAll('.option-wrap')].forEach(w=>{
    if (w === wrap) w.classList.add('is-chosen');
    else            w.classList.add('is-faded');
  });

  // ‚òÖ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á‡∏£‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (‡∏≠‡∏¥‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏á‡∏™‡∏∏‡πà‡∏°)
  if (ok){
    const pts = Number((window.__L3_SCORE_MAP || {})[idx] ?? 1);
    score += Number.isFinite(pts) ? pts : 1;

    playSfx(selectSound, VOL_SELECT);
    playSfx(hitSound,    VOL_HIT);
    flyScore(true);

    // ‚¨áÔ∏è ‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥: ‡πÑ‡∏î‡πâ 2 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‚Üí üëç, ‡πÑ‡∏î‡πâ 3 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‚Üí ‚ù§Ô∏è
    if (pts === 2)      showEmojiBurst('üëç', 120, 1000);  // (‡∏Ç‡∏ô‡∏≤‡∏î, ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤)
    else if (pts === 3) showEmojiBurst('‚ù§Ô∏è', 120, 1000);
  }else{

    score -= 1; // ‡∏ú‡∏¥‡∏î‡∏¢‡∏±‡∏á -1
    playSfx(wrongSound, VOL_WRONG);
    flyScore(false);
  }
  renderGold(score);


  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏à‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏° NEXT ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™)
  setTimeout(()=>{
  clearChoices();
  qBox.textContent = '';
  // ‚òÖ ‡∏´‡∏ô‡πà‡∏ß‡∏á‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡πâ‡∏≠‡∏¢‡∏™‡πå ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ä‡πà‡∏ß‡∏á‡πÇ‡∏û‡∏™‡∏ó‡πà‡∏≤
  enterPostPhaseAfterClearDelay();
  }, 520);

  // setTimeout(()=> { clearChoices(); qBox.textContent=''; nextRound(); }, 520);
}

function tryAnswer(el){
  if(ended||!awaitingAnswer) return;
  awaitingAnswer=false;
  const ok = (el.dataset.correct==='true');

  el.classList.remove('go-in'); el.classList.add('pick-pop');
[...choicesRow.querySelectorAll('.option.circle')].forEach(n=>{
  if(n!==el){
    n.classList.remove('go-in');
    n.classList.add('slide-up-out');
  }
});


  const chosenWrap = el.closest('.option-wrap');
  chosenWrap?.classList.add('chosen');
  choicesRow.querySelectorAll('.option-wrap').forEach(w=>{
    if (w !== chosenWrap) w.classList.add('faded');
  });

  playSfx(selectSound);
  playSfx(hitSound);

  // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
  score += ok ? 1 : -1; renderGold(score); flyScore(ok);

  // ‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏™‡∏±‡πâ‡∏ô ‡πÜ
  setTimeout(()=>{   choicesRow.style.pointerEvents = '';
  clearChoices();
  qBox.textContent = '';
  // ‚òÖ ‡∏´‡∏ô‡πà‡∏ß‡∏á‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡πâ‡∏≠‡∏¢‡∏™‡πå ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ä‡πà‡∏ß‡∏á‡πÇ‡∏û‡∏™‡∏ó‡πà‡∏≤
  enterPostPhaseAfterClearDelay();
}, 620);
}

function tryAnswer(el){
  if (ended || !awaitingAnswer) return;
  awaitingAnswer = false;
  choicesRow.style.pointerEvents = 'none';
  const ok = (el.dataset.correct==='true');

  boostQuestionOutFast(280); // ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 200-350 ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡πÉ‡∏à

  // ‡πÉ‡∏™‡πà‡∏Ñ‡∏•‡∏≤‡∏™‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡πâ "‡∏ó‡∏±‡πâ‡∏á‡∏ä‡∏∏‡∏î" (‡∏ß‡∏á‡∏Å‡∏•‡∏°+‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡∏ô)
  const chosenWrap = el.closest('.option-wrap');
  [...choicesRow.querySelectorAll('.option-wrap')].forEach(w=>{
    w.querySelector('.option.circle')?.classList.remove('go-in');
    if (w === chosenWrap) w.classList.add('is-chosen');
    else                 w.classList.add('is-faded');
  });

  if (ok) {
    playSfx(selectSound, VOL_SELECT);
    playSfx(hitSound,    VOL_HIT);
  } else {
    playSfx(wrongSound,  VOL_WRONG);
  }

  score += ok ? 1 : -1;
  renderGold(score);
  flyScore(ok);

setTimeout(()=>{
  choicesRow.style.pointerEvents = '';
  clearChoices();                  // ‚Üê ‡∏•‡πâ‡∏≤‡∏á‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏ü‡∏î‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß
  // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏≤‡∏ö‡∏π‡∏™‡∏ï‡πå‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô boostQuestionOutFast(); ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ã‡πâ‡∏≥
  qBox.textContent = '';           // ‚Üê ‡∏Å‡∏±‡∏ô‡πÄ‡∏î‡πâ‡∏á‡∏°‡∏∏‡∏°‡∏ã‡πâ‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏á

  awaitingContinue = true;
  qDecor?.classList.add('arm-next');
  syncFastNextUI();
}, 520);
}

function drawQuestion(){
  if (window.currentLevel===1) return drawLevel1();
  if (window.currentLevel===2) return drawLevel2();
  if (window.currentLevel===3) return drawLevel3();
  if (window.currentLevel===4) return drawLevel4();

  // ====== ‡∏î‡πà‡∏≤‡∏ô 5‚Äì7: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å POOL (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°) ======
  if (window.currentLevel===5) return { __textOnly:true, ...(drawLevelTextOnly(LEVEL5_CORRECT, LEVEL5_WRONG)) };
  if (window.currentLevel===6) return { __textOnly:true, ...(drawLevelTextOnly(LEVEL6_CORRECT, LEVEL6_WRONG)) };
  if (window.currentLevel===7) return { __textOnly:true, ...(drawLevelTextOnly(LEVEL7_CORRECT, LEVEL7_WRONG)) };

  return drawLevel3(); // fallback
}

// ‡∏£‡∏±‡∏ô 1 ‡∏Ç‡πâ‡∏≠
function nextRound(){
  if(ended) return;
  clearChoices(); awaitingAnswer=false;
  qBox.classList.remove('go-x','pre-x');
  // ‡∏Å‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ß‡∏¥‡πà‡∏á/‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡∏£‡∏≠‡∏ö‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏≠‡∏µ‡∏Å
  stopMarquee();


const q = drawQuestion();

// ‡πÇ‡∏´‡∏°‡∏î‡∏î‡πà‡∏≤‡∏ô 5‚Äì7: ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πâ‡∏ß‡∏ô 4 ‡∏ß‡∏á ‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤
if (q && q.__textOnly){
  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå UI ‡πÄ‡∏Å‡πà‡∏≤
  clearChoices();
  qBox.textContent = '';
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á 4 ‡∏ß‡∏á + ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏≠‡∏ö
  spawnSideOptions4Text(q.labels, q.okSet);
  awaitingAnswer = true;
} else {
  // ‡∏î‡πà‡∏≤‡∏ô 1‚Äì2 = ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß / ‡∏î‡πà‡∏≤‡∏ô 3‚Äì4 = ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
  if (window.currentLevel === 3 || window.currentLevel === 4){
    spawnRow3Multi(q.answers, q.correctIndices, q.questionText, q.scoreMap);
  } else {
    spawnRow3(q.answers, q.correctIndex, q.questionText);
  }
  awaitingAnswer = true;
}

}

// ‡∏ß‡∏á‡∏à‡∏£‡πÄ‡∏Å‡∏°: ‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏´‡∏¢‡∏∏‡∏î/‡∏™‡∏£‡∏∏‡∏õ
function scheduleGameTimer(ms){
  clearTimeout(gameTimerId);
  gameTimerId=setTimeout(()=>{ if(!ended) endLevel() }, Math.max(0,ms|0));
}
function startGameTimer(){
  remainingMs = GAME_DURATION_MS;
  gameEndAt = performance.now() + remainingMs;
  scheduleGameTimer(remainingMs);
  startClockUI();
}
function pauseGameTimer(){
  if(gameTimerId){
    remainingMs=Math.max(0,gameEndAt - performance.now());
    clearTimeout(gameTimerId); gameTimerId=null;
    pauseClockUI();
  }
}
function resumeGameTimer(){
  if(remainingMs>0 && !ended){
    gameEndAt = performance.now() + remainingMs;
    scheduleGameTimer(remainingMs);
    startClockUI();
  }
}

function startGame(){
  (async()=>{ while(!window.__ALL_IMAGES_READY__) await new Promise(r=>setTimeout(r,120)); })();
  document.body.classList.add('in-game');
  running=true; ended=false; paused=false;
  overlay.style.visibility='hidden'; overlay.style.opacity='0';
  score=0; round=0; renderGold(score);
   awaitingContinue = false;
   qDecor?.classList.remove('arm-next');
syncFastNextUI();
  bgm?.play?.().catch(()=>{});
  startGameTimer();
  nextRound();
}
function endLevel(){
  ended=true; running=false; pauseGameTimer(); stopClockUI();
  finalScoreEl.textContent=String(score);
  document.getElementById('scoreBadge').textContent = score<=5?'‚≠ê':score<=10?'‚≠ê‚≠ê':'‚≠ê‚≠ê‚≠ê';
  bgm?.pause?.(); playSfx(winSound);
qBox.textContent = '';     // ‚Üê ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
clearChoices();            // ‚Üê ‡∏•‡πâ‡∏≤‡∏á‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö

  overlay.style.visibility='visible'; overlay.style.opacity='1';
}
function resetState(){
  clearChoices(); awaitingAnswer=false; awaitingContinue=false; qDecor?.classList.remove('arm-next');
syncFastNextUI();
  qBox.textContent=''; qBox.classList.remove('go-x','pre-x');
  score=0; renderGold(score); remainingMs=GAME_DURATION_MS; stopClockUI(); clockEl.textContent='02:00';
  ended=true; running=false; paused=false;
}

// ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°
pauseBtn?.addEventListener('click', ()=>{
  if(!running||ended) return;
  if(!paused){ paused=true; pauseGameTimer(); pauseBtn.textContent='‚ñ∂Ô∏è ‡∏ï‡πà‡∏≠'; }
  else { paused=false; resumeGameTimer(); pauseBtn.textContent='‚è∏ ‡∏´‡∏¢‡∏∏‡∏î'; bgm?.play?.().catch(()=>{}); }
});
document.getElementById('quickRestart')?.addEventListener('click', ()=>{

// ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏±‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
if (window.__countdownItv) {
  clearInterval(window.__countdownItv);
  window.__countdownItv = null;
}
const startScreen  = document.getElementById('startScreen');
const countdownEl  = document.getElementById('countdown');
const startBtn     = document.getElementById('startBtn');
if (startScreen)  startScreen.style.display = 'none';
if (countdownEl){ countdownEl.style.display='none'; countdownEl.textContent='3'; }
if (startBtn){ startBtn.style.display='inline-block'; startBtn.disabled=false; startBtn.style.pointerEvents='auto'; }
document.body.classList.remove('prestart');
document.getElementById('questionBox')?.querySelector('.mq')?.style.setProperty('animation-play-state', paused ? 'paused' : 'running');
  document.getElementById('landing').classList.remove('hide');
  overlay.style.visibility='hidden'; overlay.style.opacity='0';
  resetState(); document.body.classList.remove('in-game');
});

restartBtn.addEventListener('click', ()=>{ overlay.style.visibility='hidden'; overlay.style.opacity='0'; resetState(); startGame(); bgm.currentTime=0; bgm.play().catch(()=>{}); });
selectLevelBtn.addEventListener('click', ()=>{
// ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏±‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
if (window.__countdownItv) {
  clearInterval(window.__countdownItv);
  window.__countdownItv = null;
}
const startScreen  = document.getElementById('startScreen');
const countdownEl  = document.getElementById('countdown');
const startBtn     = document.getElementById('startBtn');
if (startScreen)  startScreen.style.display = 'none';
if (countdownEl){ countdownEl.style.display='none'; countdownEl.textContent='3'; }
if (startBtn){ startBtn.style.display='inline-block'; startBtn.disabled=false; startBtn.style.pointerEvents='auto'; }
document.body.classList.remove('prestart');

  overlay.style.visibility='hidden'; overlay.style.opacity='0';
  resetState(); document.body.classList.remove('in-game');
  document.getElementById('landing').classList.remove('hide'); bgm.currentTime=0; bgm.play().catch(()=>{});
});

// Welcome ‚Üí Landing ‚Üí Start
(function(){
  const welcome = document.getElementById('welcome');
  const enterBtn = document.getElementById('enterBtn');
  const landing = document.getElementById('landing');
  enterBtn.addEventListener('click', async ()=>{
    while(!window.__ALL_IMAGES_READY__) await new Promise(r=>setTimeout(r,120));
    welcome.classList.add('hide'); landing.classList.remove('hide'); bgm?.play?.().catch(()=>{});
  });
})();

(function(){
  const landing = document.getElementById('landing');
  const startScreen = document.getElementById('startScreen');
  const guideScreen = document.getElementById('guideScreen');
  const startBtn = document.getElementById('startBtn');
  const countdownEl = document.getElementById('countdown');

  document.querySelectorAll('.levelBtn').forEach(btn=>{
    if(btn.id==='guideBtn') return;
    btn.addEventListener('click', ()=>{
      window.currentLevel = Number(btn.dataset.level||1);
      landing.classList.add('hide');
      document.body.classList.add('prestart');
      startScreen.style.display='flex';
      // ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ï‡∏≤‡∏°‡∏î‡πà‡∏≤‡∏ô
      const st = document.getElementById('startTitle');

st.textContent =
  (window.currentLevel===1)
    ? '‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à : ‡∏ô‡∏≥‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏à‡∏≤‡∏Å‡∏™‡∏≤‡∏¢‡∏û‡∏≤‡∏ô‡πÑ‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'
  : (window.currentLevel===2)
    ? '‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏´‡πâ‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏ö‡∏ô‡∏™‡∏≤‡∏¢‡∏û‡∏≤‡∏ô'
  : (window.currentLevel===3)
    ? '‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î'
  : (window.currentLevel===4)
    ? '‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡πÉ‡∏´‡πâ‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏™‡∏î‡∏∏'
  : (window.currentLevel===5)
    ? '‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏ç‡πà ‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏û'
  : (window.currentLevel===6)
    ? '‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å ‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏û'
  : (window.currentLevel===7)
    ? '‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'
  : '‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏à‡∏ó‡∏¢‡πå';

      // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏° / ‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á
      startBtn.style.display='inline-block'; startBtn.disabled=false; startBtn.style.pointerEvents='auto';
      countdownEl.style.display='none'; countdownEl.textContent='3';
    });
  });

  document.getElementById('guideBtn')?.addEventListener('click', ()=>{ landing.classList.add('hide'); guideScreen.style.display='flex' });
  document.getElementById('guideBack')?.addEventListener('click', ()=>{ guideScreen.style.display='none'; landing.classList.remove('hide') });

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° + ‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á 3..2..1
let countdownItv=null; // ‚Üê ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏õ

// === ‡πÉ‡∏™‡πà‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ó‡∏ô ===
window.__countdownItv = null;
function clearCountdown(){
  if(window.__countdownItv){
    clearInterval(window.__countdownItv);
    window.__countdownItv = null;
  }
  countdownEl.style.display='none'; countdownEl.textContent='3';
  startBtn.style.display='inline-block'; startBtn.disabled=false; startBtn.style.pointerEvents='auto';
}
function runCountdown(){
  startBtn.disabled=true; startBtn.style.pointerEvents='none'; startBtn.style.display='none';
  let n=3; countdownEl.textContent=n; countdownEl.style.display='block';
  window.__countdownItv = setInterval(()=>{
    n--;
    if(n>0){ countdownEl.textContent=n; }
    else{ clearCountdown(); startScreen.style.display='none'; startGame(); }
  },1000);
}

  startBtn.addEventListener('click', ()=>{ runCountdown(); });
})();

// =========================
// Visibility Pause
// =========================
let wasRunning=false;
function uiBlockingOpen(){
  const landing=document.getElementById('landing');
  const startOpen = (document.getElementById('startScreen').style.display!=='none');
  const guide=document.getElementById('guideScreen');
  const guideOpen = getComputedStyle(guide).display!=='none';
  const overlayOpen = overlay.style.visibility==='visible';
  return overlayOpen || (!landing.classList.contains('hide')) || startOpen || guideOpen;
}
function handleHidden(){ wasRunning = running && !ended && !uiBlockingOpen(); if(wasRunning) { paused=true; pauseGameTimer(); } }
function handleVisible(){ if(wasRunning && paused && !ended && !uiBlockingOpen()){ paused=false; resumeGameTimer(); } wasRunning=false }
document.addEventListener('visibilitychange', ()=>{ if(document.hidden) handleHidden(); else handleVisible() });
window.addEventListener('blur', handleHidden); window.addEventListener('focus', handleVisible);

})();
</script>

<!-- ===== ‡∏Å‡∏•‡πâ‡∏≠‡∏á (‡∏°‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏á‡∏Å‡∏•‡∏°‡πÅ‡∏ï‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πâ‡∏≠‡∏¢‡∏™‡πå) ===== -->
<script type="module">
import {PoseLandmarker, FilesetResolver} from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3";
const camBtn = document.getElementById('camBtn');
const video  = document.getElementById('cameraMirror');
const cvs    = document.getElementById('camCanvas');
const ctx    = cvs.getContext('2d', { alpha: true });
const DETECT_W = 320;
let detectCanvas = document.createElement('canvas');
let detectCtx = detectCanvas.getContext('2d', { alpha:false, desynchronized:true });
let CAM_ON=false, landmarker=null, raf=0, stream=null;
// ‚≠êÔ∏è Gesture config/state (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å NEXT ‡∏î‡πâ‡∏ß‡∏¢‡∏ó‡πà‡∏≤‡πÅ‡∏ï‡∏∞‡∏´‡∏±‡∏ß‡∏™‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏á)
const GESTURE_NEXT = {
  distThresh: 0.12,     // ‡∏£‡∏∞‡∏¢‡∏∞ wrists‚Üîears (‡∏´‡∏ô‡πà‡∏ß‡∏¢ normalized) ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ
  framesNeeded: 6,      // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ N ‡πÄ‡∏ü‡∏£‡∏°
  window: 8,            // ‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö M ‡πÄ‡∏ü‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
  cooldownMs: 1200      // ‡∏Å‡∏±‡∏ô‡∏•‡∏±‡πà‡∏ô: ‡∏£‡∏∞‡∏¢‡∏∞‡∏û‡∏±‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏£‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå (‡∏°‡∏¥‡∏•‡∏•‡∏¥‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
};
let __poseHits = [];     // ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏ü‡∏£‡∏° (boolean) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡πà‡∏≤ this-round
let __poseCooldownUntil = 0;  // timestamp ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á ‚Äú‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏£‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‚Äù


function fitCanvas(){ const dpr = CAM_ON? 1 : Math.max(1, window.devicePixelRatio||1); cvs.width=Math.round(innerWidth*dpr); cvs.height=Math.round(innerHeight*dpr); cvs.style.width=innerWidth+'px'; cvs.style.height=innerHeight+'px'; ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr) }
fitCanvas(); addEventListener('resize', fitCanvas);
function coverCropRect(){ const vw=video.videoWidth||640, vh=video.videoHeight||480; const sw=innerWidth, sh=innerHeight; const scale=Math.max(sw/vw, sh/vh); const sW=Math.round(sw/scale), sH=Math.round(sh/scale); const sX=Math.round((vw-sW)/2), sY=Math.round((vh-sH)/2); return {sX,sY,sW,sH,vw,vh,sw,sh} }
function mapToScreen(nx,ny){ const {sX,sY,sW,sH,vw,vh,sw,sh} = coverCropRect(); const px=nx*vw, py=ny*vh; const u=(px-sX)/sW, v=(py-sY)/sH; let x=u*sw, y=v*sh; x=sw-x; return {x,y} }

const SHOW_HAND_BALL=false;
const lastHitAt=new WeakMap();
const HIT_LOCK_MS=160;
function circleIntersectsRect(cx,cy,r, rc){ const nx=Math.max(rc.left, Math.min(cx, rc.right)); const ny=Math.max(rc.top, Math.min(cy, rc.bottom)); const dx=cx-nx, dy=cy-ny; return (dx*dx+dy*dy)<=r*r }
function hitByCircle(center, r){
  if (window.ended) return;
const opts = [...document.querySelectorAll('.option.circle')];
const extras = [];
if (qDecor) extras.push(qDecor);
const fastRect = document.getElementById('fastNext');
if (fastRect) extras.push(fastRect);



for (const n of [...opts, ...extras]){
  const rc = n.getBoundingClientRect();

if (circleIntersectsRect(center.x, center.y, r, rc)){
  const t = performance.now();
  const last = lastHitAt.get(n) || 0;
  if (t - last < HIT_LOCK_MS) continue;
  lastHitAt.set(n, t);

  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô qDecor (object0) ‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà ‚Üí ‡∏™‡∏±‡πà‡∏á next ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
  if (n === qDecor){
    if (awaitingContinue && !ended) {
      qDecor.click(); // ‡∏à‡∏∞‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á belt ‡πÅ‡∏•‡∏∞ nextRound() ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏ú‡∏π‡∏Å‡πÑ‡∏ß‡πâ
    }
    continue;
  }

  // ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏Å‡∏ï‡∏¥
  (n).click();
}
  }
}
async function ensureLandmarker(){ if(landmarker) return landmarker; const fileset = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"); landmarker = await PoseLandmarker.createFromOptions(fileset, { baseOptions:{ modelAssetPath:"https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task" }, runningMode:'VIDEO', numPoses:1, minPoseDetectionConfidence:.35, minPosePresenceConfidence:.35, minTrackingConfidence:.35 }); return landmarker }
function drawHandBall(elbowIdx, wristIdx, lm){ if(!lm[elbowIdx]||!lm[wristIdx]) return null; const elbow = mapToScreen(lm[elbowIdx].x, lm[elbowIdx].y); const wrist = mapToScreen(lm[wristIdx].x, lm[wristIdx].y); const r=24; const L=Math.max(1, Math.hypot(wrist.x-elbow.x, wrist.y-elbow.y)); const ux=(wrist.x-elbow.x)/L, uy=(wrist.y-elbow.y)/L; const HAND_PUSH=1.5, PUSH_PX=6; const center={ x: wrist.x + ux*(r*HAND_PUSH+PUSH_PX), y: wrist.y + uy*(r*HAND_PUSH+PUSH_PX) }; if(SHOW_HAND_BALL){ ctx.beginPath(); ctx.arc(center.x,center.y,r,0,Math.PI*2); ctx.fillStyle='#fff'; ctx.fill(); ctx.lineWidth=3; ctx.strokeStyle='#fff'; ctx.stroke(); } hitByCircle(center, r*.95); return center }

// ‚≠êÔ∏è ‡∏£‡∏∞‡∏¢‡∏∞‡πÅ‡∏ö‡∏ö normalized (x,y ‚àà [0,1])
function dist2D(a, b){
  if(!a || !b) return Infinity;
  const dx = a.x - b.x, dy = a.y - b.y;
  return Math.hypot(dx, dy);
}

// ‚≠êÔ∏è ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤ ‚Äú‡∏°‡∏∑‡∏≠‡∏ã‡πâ‡∏≤‡∏¢‡πÅ‡∏ï‡∏∞‡∏´‡∏π‡∏ã‡πâ‡∏≤‡∏¢‚Äù ‡πÅ‡∏•‡∏∞ ‚Äú‡∏°‡∏∑‡∏≠‡∏Ç‡∏ß‡∏≤‡πÅ‡∏ï‡∏∞‡∏´‡∏π‡∏Ç‡∏ß‡∏≤‚Äù ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
function bothHandsOnHead(lm){
  // ‡∏î‡∏±‡∏ä‡∏ô‡∏µ BlazePose:
  //  7 = left ear,  8 = right ear, 15 = left wrist, 16 = right wrist

  const L_EAR = lm[7],  R_EAR = lm[8];
  const L_WR  = lm[15], R_WR  = lm[16];
  if(!L_EAR || !R_EAR || !L_WR || !R_WR) return false;

  const hitL = dist2D(L_WR, L_EAR) <= GESTURE_NEXT.distThresh;
  const hitR = dist2D(R_WR, R_EAR) <= GESTURE_NEXT.distThresh;
  return hitL && hitR;
}

// ‚≠êÔ∏è G5 ‡πÉ‡∏´‡∏°‡πà: "‡∏™‡∏≠‡∏á‡πÅ‡∏Ç‡∏ô‡∏ä‡∏µ‡πâ‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô)" ‚Üí ‡∏ú‡πà‡∏≠‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå: ‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏î‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏ä‡∏µ‡πâ‡∏ï‡∏£‡∏á‡∏û‡∏≠
const GESTURE_G5 = {
  minForearmLen: 0.10,      // ‡∏¢‡∏∑‡∏î‡πÅ‡∏Ç‡∏ô‡∏û‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏∏‡∏î
  maxForearmAngleRad: 0.61, // ~35¬∞ ‡∏à‡∏≤‡∏Å‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô (‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ‡∏û‡∏≠‡∏Ñ‡∏ß‡∏£)
  minHorizX: 0.06           // ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏û‡πÄ‡∏ô‡∏ô‡∏ï‡πå‡πÅ‡∏Å‡∏ô X ‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏≠‡∏°‡∏µ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ä‡∏µ‡πâ‡∏Ç‡∏∂‡πâ‡∏ô/‡∏•‡∏á‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏ó‡∏µ
};

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÉ‡∏´‡∏°‡πà: ‡∏ú‡πà‡∏≤‡∏ô‡∏ñ‡πâ‡∏≤ "‡∏ã‡πâ‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏ß‡∏≤" ‡∏ï‡∏¥‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ç‡πâ‡∏≤‡∏á
function bothForearmsPointSameSide(lm){
  const LE=lm[13], LW=lm[15], RE=lm[14], RW=lm[16];
  if(!LE||!LW||!RE||!RW) return false;

  const vLx = LW.x-LE.x, vLy = LW.y-LE.y;
  const vRx = RW.x-RE.x, vRy = RW.y-RE.y;

  const lenL = Math.hypot(vLx, vLy);
  const lenR = Math.hypot(vRx, vRy);

  // ‡πÄ‡∏ä‡πá‡∏Å "‡πÅ‡∏Ç‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß" ‡πÉ‡∏´‡πâ‡∏ä‡∏µ‡πâ‡∏ï‡∏£‡∏á‡∏û‡∏≠ (‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô ¬±35¬∞, ‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏î‡πÅ‡∏Ç‡∏ô‡∏û‡∏≠)
  const leftOK  = lenL >= GESTURE_G5.minForearmLen
               && Math.abs(Math.atan2(vLy, vLx)) <= GESTURE_G5.maxForearmAngleRad
               && Math.abs(vLx) >= GESTURE_G5.minHorizX;

  const rightOK = lenR >= GESTURE_G5.minForearmLen
               && Math.abs(Math.atan2(vRy, vRx)) <= GESTURE_G5.maxForearmAngleRad
               && Math.abs(vRx) >= GESTURE_G5.minHorizX;

  return leftOK || rightOK; // ‚úÖ ‡∏ú‡πà‡∏≤‡∏ô‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ç‡πâ‡∏≤‡∏á‡∏ä‡∏µ‡πâ‡∏ï‡∏£‡∏á‡∏û‡∏≠
}

// helper (‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ)
function near(a,b,thr){ if(!a||!b) return false; return dist2D(a,b) <= (thr ?? 0.12); }
function between(y, a, b){ const lo=Math.min(a,b), hi=Math.max(a,b); return y>=lo && y<=hi; }

// 1) ‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏°‡∏∑‡∏≠‡∏ä‡∏ô‡∏Å‡∏±‡∏ô "‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏´‡∏±‡∏ß"
function handsCircleOverHead(lm){
  const L_WR=lm[15], R_WR=lm[16], NOSE=lm[0], L_EYE=lm[1], R_EYE=lm[2];
  if(!L_WR||!R_WR||!NOSE) return false;
  const headY = Math.min(NOSE.y, (L_EYE?.y ?? NOSE.y), (R_EYE?.y ?? NOSE.y));
  const together = dist2D(L_WR,R_WR) <= 0.10;       // ‡∏ä‡∏¥‡∏î‡∏Å‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏á‡∏Å‡∏•‡∏°
  const above    = (L_WR.y < headY) && (R_WR.y < headY);
  return together && above;
}

// 2) ‡∏°‡∏∑‡∏≠‡πÅ‡∏ï‡∏∞‡∏Å‡∏±‡∏ô ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏±‡∏ß ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡πâ‡∏≠‡∏á
function handsCircleUnderHead(lm){
  const L_WR = lm[15], R_WR = lm[16];
  const NOSE = lm[0], L_EYE = lm[1], R_EYE = lm[2];
  if(!L_WR || !R_WR || !NOSE) return false;

  // ===== ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏´‡∏•‡∏±‡∏Å =====
  const headTopY = Math.min(
    NOSE.y,
    (L_EYE?.y ?? NOSE.y),
    (R_EYE?.y ?? NOSE.y)
  ); // ‡∏¢‡∏¥‡πà‡∏á y ‡∏ô‡πâ‡∏≠‡∏¢ = ‡∏¢‡∏¥‡πà‡∏á‡∏™‡∏π‡∏á
  const { hipsY } = torsoRef(lm); // ‡πÉ‡∏ä‡πâ hips ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ô‡∏ß‡∏ó‡πâ‡∏≠‡∏á

  // ===== ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç =====
  const together = dist2D(L_WR, R_WR) <= 0.12; // ‡∏°‡∏∑‡∏≠‡πÅ‡∏ï‡∏∞‡∏Å‡∏±‡∏ô
  const wristsAvgY = (L_WR.y + R_WR.y) / 2;   // ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏∑‡∏≠
  const underHead = wristsAvgY > headTopY;    // ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏±‡∏ß
  const aboveBelly = wristsAvgY < hipsY + 0.05; // ‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡πâ‡∏≠‡∏á (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏¢‡∏∞‡∏ô‡∏¥‡∏î)

  return together && underHead && aboveBelly;
}


// 3) ‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏°‡∏∑‡∏≠‡πÅ‡∏ï‡∏∞ "‡∏Ç‡∏≤‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏î‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á"
function handCircleAtLeg(lm){
  const L_WR=lm[15], R_WR=lm[16], L_KNEE=lm[25], R_KNEE=lm[26], L_ANK=lm[27], R_ANK=lm[28];
  if(!L_WR||!R_WR) return false;
  const hitLeft  = near(L_WR, L_KNEE, 0.12) || near(L_WR, L_ANK, 0.12) || near(R_WR, L_KNEE, 0.12) || near(R_WR, L_ANK, 0.12);
  const hitRight = near(L_WR, R_KNEE, 0.12) || near(L_WR, R_ANK, 0.12) || near(R_WR, R_KNEE, 0.12) || near(R_WR, R_ANK, 0.12);
  return !!(hitLeft || hitRight);
}

// 4) ‡∏°‡∏∑‡∏≠‡∏™‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏á‡∏ä‡∏µ‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡∏≥‡∏ï‡∏±‡∏ß "‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏ö‡∏ô‚Äì‡∏•‡πà‡∏≤‡∏á" (‡πÉ‡∏Å‡∏•‡πâ‡∏•‡∏≥‡∏ï‡∏±‡∏ß ‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡∏ã‡πâ‡∏≠‡∏ô x ‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏±‡∏ô)
function sideStackedPoint(lm){
  const L_WR=lm[15], R_WR=lm[16], L_HIP=lm[23], R_HIP=lm[24];
  if(!L_WR||!R_WR||!L_HIP||!R_HIP) return false;
  const torsoX = (L_HIP.x + R_HIP.x)/2;
  const nearTorsoX = (p)=> Math.abs(p.x - torsoX) <= 0.10;  // ‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡∏≥‡∏ï‡∏±‡∏ß
  const stackY = Math.abs(L_WR.y - R_WR.y) >= 0.10;         // ‡∏ã‡πâ‡∏≠‡∏ô‡∏ö‡∏ô‚Äì‡∏•‡πà‡∏≤‡∏á
  const nearSide = nearTorsoX(L_WR) && nearTorsoX(R_WR);
  return nearSide && stackY;
}

// 5) ‡∏°‡∏∑‡∏≠‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ä‡πà‡∏ß‡∏á‡∏®‡∏µ‡∏£‡∏©‡∏∞‚Üí‡∏ó‡πâ‡∏≠‡∏á (‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏®‡∏µ‡∏£‡∏©‡∏∞‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏£‡πà‡∏á) + ‡∏≠‡∏µ‡∏Å‡∏°‡∏∑‡∏≠‡∏ä‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á
const CHIN_SIDE = {
  xAlign: 0.12,        // ‡∏°‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ä‡πà‡∏ß‡∏á‡∏®‡∏µ‡∏£‡∏©‡∏∞‚Üí‡∏ó‡πâ‡∏≠‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏Å‡∏•‡πâ‡πÅ‡∏Å‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤ (NOSE.x) ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ
  yHeadOffset: 0.02,   // ‡∏Ç‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏®‡∏µ‡∏£‡∏©‡∏∞‡∏•‡∏á‡∏°‡∏≤‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢
  yBellyMargin: 0.04,  // ‡∏Ç‡∏≠‡∏ö‡∏ö‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ó‡πâ‡∏≠‡∏á (‡∏≠‡∏¥‡∏á hipsY) ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢
  minSideX: 0.20       // ‡∏°‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏≠‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏µ‡πâ
};

function chinAndSide(lm){
  const L_WR = lm[15], R_WR = lm[16];
  const NOSE = lm[0], L_EYE = lm[1], R_EYE = lm[2];
  if(!L_WR || !R_WR || !NOSE) return false;

  // ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏®‡∏µ‡∏£‡∏©‡∏∞ (y ‡∏¢‡∏¥‡πà‡∏á‡∏ô‡πâ‡∏≠‡∏¢ = ‡∏¢‡∏¥‡πà‡∏á‡∏™‡∏π‡∏á)
  const headTopY = Math.min(
    NOSE.y,
    (L_EYE?.y ?? NOSE.y),
    (R_EYE?.y ?? NOSE.y)
  );

  // ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ó‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏™‡∏∞‡πÇ‡∏û‡∏Å
  const { hipsY } = torsoRef(lm);

  // ‡∏°‡∏∑‡∏≠ "‡πÉ‡∏ô‡πÅ‡∏ô‡∏ß‡∏î‡∏¥‡πà‡∏á‡∏Å‡∏±‡∏ö‡∏®‡∏µ‡∏£‡∏©‡∏∞" ‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏ä‡πà‡∏ß‡∏á‡∏®‡∏µ‡∏£‡∏©‡∏∞‚Üí‡∏ó‡πâ‡∏≠‡∏á
  const inHeadToBelly = (w)=>{
    if(!w) return false;
    const yOk = between(w.y, headTopY + CHIN_SIDE.yHeadOffset, hipsY + CHIN_SIDE.yBellyMargin);
    const xOk = Math.abs(w.x - NOSE.x) <= CHIN_SIDE.xAlign;
    return yOk && xOk;
  };

  const leftAxis  = inHeadToBelly(L_WR);
  const rightAxis = inHeadToBelly(R_WR);

  // ‡∏ñ‡πâ‡∏≤‡∏°‡∏∑‡∏≠‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏∑‡∏≠ "‡πÅ‡∏ô‡∏ß‡∏î‡∏¥‡πà‡∏á‡∏Å‡∏±‡∏ö‡∏®‡∏µ‡∏£‡∏©‡∏∞" ‚Üí ‡∏°‡∏∑‡∏≠‡∏Ç‡∏ß‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á (‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏Å‡∏±‡∏ô)
  const other = leftAxis ? R_WR : rightAxis ? L_WR : null;
  if(!other) return false;

  // ‡∏°‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏≠‡∏á "‡∏≠‡∏≠‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á" ‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠
  const xDelta = Math.abs(other.x - NOSE.x);
  return xDelta >= CHIN_SIDE.minSideX;
}


// ===== ‡∏ó‡πà‡∏≤ post7..post15 =====

// ‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏´‡∏•‡∏±‡∏Å ‡πÜ ‡∏Ç‡∏≠‡∏á‡∏•‡∏≥‡∏ï‡∏±‡∏ß
function torsoRef(lm){
  const NOSE=lm[0], L_EYE=lm[1], R_EYE=lm[2], L_SH=lm[11], R_SH=lm[12], L_HIP=lm[23], R_HIP=lm[24];
  const headTopY = Math.min(NOSE?.y??1, L_EYE?.y??1, R_EYE?.y??1);
  const shouldersY = Math.min(L_SH?.y??1, R_SH?.y??1);
  const chestY = (L_SH&&R_SH)? ((L_SH.y+R_SH.y)/2 + 0.06) : (shouldersY+0.08);
  const hipsY = (L_HIP&&R_HIP)? ( (L_HIP.y+R_HIP.y)/2 ) : (shouldersY+0.20);
  const midX = ( (L_SH?.x??0) + (R_SH?.x??0) + (L_HIP?.x??0) + (R_HIP?.x??0) ) / 4;
  const shoulderSpanX = Math.abs((L_SH?.x??0) - (R_SH?.x??0));
  return { headTopY, shouldersY, chestY, hipsY, midX, shoulderSpanX };
}
function close2(a,b,t=0.10){ if(!a||!b) return false; return dist2D(a,b) <= t; }
function raisedAnkleSide(lm, side/*'L'|'R'*/, lift=0.06){
  const knee = lm[ side==='L' ? 25 : 26 ];
  const ank  = lm[ side==='L' ? 27 : 28 ];
  if(!knee||!ank) return false;
  // ‡∏¢‡∏Å‡∏Ç‡∏≤ = ‡∏Ç‡πâ‡∏≠‡πÄ‡∏ó‡πâ‡∏≤‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Ç‡πà‡∏≤‡∏û‡∏≠‡∏™‡∏°‡∏Ñ‡∏ß‡∏£ (y ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤)
  return (ank.y < (knee.y - lift));
}
function wristAboveHead(lm, side){
  const WR = lm[ side==='L' ? 15 : 16 ];
  if(!WR) return false;
  const { headTopY } = torsoRef(lm);
  return WR.y < headTopY - 0.02;
}
function wristNearBelly(lm, side){
  const WR = lm[ side==='L' ? 15 : 16 ];
  const { chestY, hipsY, midX } = torsoRef(lm);
  if(!WR) return false;
  const yOk = between(WR.y, chestY-0.02, hipsY+0.06);
  const xOk = Math.abs(WR.x - midX) <= 0.12;
  return yOk && xOk;
}

// post7: ‡∏ô‡∏±‡∏Å‡∏Å‡∏•‡πâ‡∏≤‡∏° 
function poseBodybuilder(lm){
  const leftBelly  = wristNearBelly(lm,'L');
  const rightBelly = wristNearBelly(lm,'R');
  const leftUp     = wristAboveHead(lm,'L');
  const rightUp    = wristAboveHead(lm,'R');
  return (leftBelly && rightUp) || (rightBelly && leftUp);
}

// post8: ‡πÅ‡∏¢‡∏Å‡∏Ç‡∏≤ ‚Äî ‡∏£‡∏∞‡∏¢‡∏∞‡∏Ç‡πâ‡∏≠‡πÄ‡∏ó‡πâ‡∏≤‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏ä‡πà‡∏ß‡∏á‡πÑ‡∏´‡∏•‡πà
function poseSplitLegs(lm){
  const L_ANK=lm[27], R_ANK=lm[28]; if(!L_ANK||!R_ANK) return false;
  const { shoulderSpanX } = torsoRef(lm);
  const ankleSpanX = Math.abs(L_ANK.x - R_ANK.x);
  return ankleSpanX >= (shoulderSpanX * 1.20);
}


// post10: ‡∏¢‡∏¥‡∏á‡∏õ‡∏∑‡∏ô ‚Äî ‡πÅ‡∏Ç‡∏ô‡∏ã‡πâ‡∏≠‡∏ô‡∏ä‡∏µ‡πâ‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
// post10: ‡∏¢‡∏¥‡∏á‡∏õ‡∏∑‡∏ô (‡∏£‡∏∏‡πà‡∏ô‡∏á‡πà‡∏≤‡∏¢) ‚Äî ‡∏°‡∏∑‡∏≠‡πÅ‡∏ï‡∏∞‡∏Å‡∏±‡∏ô + ‡∏≠‡∏¢‡∏π‡πà‡∏´‡πà‡∏≤‡∏á‡∏•‡∏≥‡∏ï‡∏±‡∏ß‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á
const GESTURE_GUN = {
  maxWristGap: 0.10,     // ‡∏£‡∏∞‡∏¢‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏∑‡∏≠‡∏ä‡∏ô‡∏Å‡∏±‡∏ô (‡πÅ‡∏ï‡∏∞‡∏Å‡∏±‡∏ô)
  minSideOffset: 0.18,   // ‡∏£‡∏∞‡∏¢‡∏∞‡∏≠‡∏≠‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏Å‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏•‡∏≥‡∏ï‡∏±‡∏ß (‡∏¢‡∏¥‡πà‡∏á‡∏°‡∏≤‡∏Å‡∏¢‡∏¥‡πà‡∏á‡πÑ‡∏Å‡∏•‡∏ï‡∏±‡∏ß)
};

function poseGunStack(lm){
  const L_WR = lm[15], R_WR = lm[16];
  if(!L_WR || !R_WR) return false;

  // ‡∏ï‡πâ‡∏≠‡∏á "‡πÅ‡∏ï‡∏∞‡∏Å‡∏±‡∏ô"
  const together = dist2D(L_WR, R_WR) <= GESTURE_GUN.maxWristGap;

  // ‡∏ï‡πâ‡∏≠‡∏á "‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏≥‡∏ï‡∏±‡∏ß" ‡∏ó‡∏≤‡∏á‡πÅ‡∏Å‡∏ô X ‡∏û‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì
  const { midX } = torsoRef(lm);              // ‡πÅ‡∏Å‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏•‡∏≥‡∏ï‡∏±‡∏ß
  const wristsMidX = (L_WR.x + R_WR.x) / 2;   // ‡∏à‡∏∏‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏∑‡∏≠
  const sideAway = Math.abs(wristsMidX - midX) >= GESTURE_GUN.minSideOffset;

  // ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á‚Äì‡∏ï‡πà‡∏≥ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡∏á‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
  return together && sideAway;
}


// post13: ‡∏ï‡∏±‡∏ß‡πÇ‡∏≠‡∏ó‡∏µ‡πà‡∏ó‡πâ‡∏≠‡∏á ‚Äî ‡∏°‡∏∑‡∏≠‡∏™‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏á‡πÅ‡∏ï‡∏∞‡∏Å‡∏±‡∏ô‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡πâ‡∏≠‡∏á
function poseOBelly(lm){
  const L_WR=lm[15], R_WR=lm[16]; if(!L_WR||!R_WR) return false;
  const nearEach = dist2D(L_WR,R_WR) <= 0.10;
  const { chestY, hipsY, midX } = torsoRef(lm);
  const yOk = between((L_WR.y+R_WR.y)/2, chestY-0.02, hipsY+0.06);
  const xOk = Math.abs(((L_WR.x+R_WR.x)/2) - midX) <= 0.12;
  return nearEach && yOk && xOk;
}

// post14: ‡πÄ‡∏≠‡πá‡∏Å‡∏ã‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏Å ‚Äî ‡∏Ç‡πâ‡∏≠‡∏°‡∏∑‡∏≠‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏±‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡πÅ‡∏ô‡∏ß‡πÑ‡∏Ç‡∏ß‡πâ
function poseXChest(lm){
  const L_WR=lm[15], R_WR=lm[16], LE=lm[13], RE=lm[14];
  if(!L_WR||!R_WR||!LE||!RE) return false;
  const { shouldersY, chestY } = torsoRef(lm);
  const nearEach = dist2D(L_WR,R_WR) <= 0.10;
  const yCenter  = (L_WR.y+R_WR.y)/2;
  const yOk = between(yCenter, shouldersY-0.02, chestY+0.04);
  // ‡πÑ‡∏Ç‡∏ß‡πâ: ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏∑‡∏≠‡∏Å‡∏±‡∏ö‡∏®‡∏≠‡∏Å‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏±‡∏ô
  const wristOrder = Math.sign(L_WR.x - R_WR.x);
  const elbowOrder = Math.sign(LE.x   - RE.x);
  const crossed = wristOrder !== 0 && elbowOrder !== 0 && (wristOrder !== elbowOrder);
  return nearEach && yOk && crossed;
}

// post15: ‡∏ó‡πà‡∏≤‡∏•‡∏¥‡∏á ‚Äî ‡∏°‡∏∑‡∏≠‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÅ‡∏ï‡∏∞‡∏´‡∏±‡∏ß ‡∏≠‡∏µ‡∏Å‡∏°‡∏∑‡∏≠‡πÅ‡∏ï‡∏∞‡∏ó‡πâ‡∏≠‡∏á
function poseMonkey(lm){
  const L_WR=lm[15], R_WR=lm[16], L_EAR=lm[7], R_EAR=lm[8];
  if(!L_WR||!R_WR||!L_EAR||!R_EAR) return false;
  const leftHead  = close2(L_WR, L_EAR, 0.12) || close2(L_WR, R_EAR, 0.12);
  const rightHead = close2(R_WR, L_EAR, 0.12) || close2(R_WR, R_EAR, 0.12);
  const leftBelly = wristNearBelly(lm,'L');
  const rightBelly= wristNearBelly(lm,'R');
  return (leftHead && rightBelly) || (rightHead && leftBelly);
}


// post16: ‡∏ô‡∏±‡πà‡∏á + ‡∏°‡∏∑‡∏≠‡πÅ‡∏ï‡∏∞‡∏Ç‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ç‡πà‡∏≤
function poseSitHandsOnKnees(lm){
  const L_WR=lm[15], R_WR=lm[16], L_K=lm[25], R_K=lm[26];
  if(!L_WR||!R_WR||!L_K||!R_K) return false;
  const nearLeft  = near(L_WR, L_K, 0.12) || near(R_WR, L_K, 0.12);
  const nearRight = near(L_WR, R_K, 0.12) || near(R_WR, R_K, 0.12);
  // ‡πÇ‡∏ü‡∏Å‡∏±‡∏™ ‚Äú‡∏°‡∏∑‡∏≠‡πÅ‡∏ï‡∏∞‡πÄ‡∏Ç‡πà‡∏≤/‡∏Ç‡∏≤‚Äù ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î‡∏ó‡πà‡∏≤‡∏á‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
  return nearLeft && nearRight;
}

// post17: ‡πÅ‡∏¢‡∏Å‡∏Ç‡∏≤‡∏Å‡∏ß‡πâ‡∏≤‡∏á + ‡∏ä‡∏π‡∏°‡∏∑‡∏≠‡∏™‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏´‡∏±‡∏ß
function poseSplitLegsArmsUp(lm){
  const legsWide = poseSplitLegs(lm); // ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏î‡∏¥‡∏° (‡∏£‡∏∞‡∏¢‡∏∞‡∏Ç‡πâ‡∏≠‡πÄ‡∏ó‡πâ‡∏≤‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏´‡∏•‡πà)
  const armsUp   = wristAboveHead(lm,'L') && wristAboveHead(lm,'R');
  return legsWide && armsUp;
}

// post19: ‡∏¢‡∏Å‡∏™‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏®‡∏µ‡∏£‡∏©‡∏∞
function poseArmAtHeadLevel(lm){
  // ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
  const NOSE = lm[0], L_EYE = lm[1], R_EYE = lm[2];
  const L_WR = lm[15], R_WR = lm[16];
  if(!NOSE || !L_WR || !R_WR) return false;

  // ‡∏£‡∏∞‡∏î‡∏±‡∏ö "‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏ô‡∏Ç‡∏≠‡∏á‡∏®‡∏µ‡∏£‡∏©‡∏∞" ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏à‡∏≤‡∏Å‡∏à‡∏°‡∏π‡∏Å/‡∏ï‡∏≤ (y ‡∏¢‡∏¥‡πà‡∏á‡∏ô‡πâ‡∏≠‡∏¢ = ‡∏™‡∏π‡∏á)
  const headTopY = Math.min(
    NOSE.y,
    (L_EYE?.y ?? NOSE.y),
    (R_EYE?.y ?? NOSE.y)
  );

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏∑‡∏≠‡∏ã‡πâ‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Ç‡∏ß‡∏≤ "‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤" ‡∏®‡∏µ‡∏£‡∏©‡∏∞ (y ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ headTopY)
  const leftAboveHead  = L_WR.y < headTopY - 0.02;
  const rightAboveHead = R_WR.y < headTopY - 0.02;

  // ‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏Å‡∏™‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
  return leftAboveHead && rightAboveHead;
}


// ‚≠êÔ∏è ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏ü‡∏£‡∏° + ‡∏ó‡∏£‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå NEXT ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
function updateNextPose(lm){
  // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡∏°‡∏ï‡πâ‡∏≠‡∏á ‚Äú‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡πÑ‡∏õ‡∏ï‡πà‡∏≠‚Äù ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  if(!CAM_ON) return;
  if(performance.now() < __poseCooldownUntil) return;
  const cue = (window.__currentPostGesture || 'ears');
  let ok = false;
  switch(cue){
    case 'ears':     ok = !!bothHandsOnHead(lm); break;
    case 'overhead': ok = !!handsCircleOverHead(lm); break;
    case 'underhead':ok = !!handsCircleUnderHead(lm); break;
    case 'leg':      ok = !!handCircleAtLeg(lm); break;
    case 'sameDir':  ok = !!bothForearmsPointSameSide(lm); break;
    case 'chinSide': ok = !!chinAndSide(lm); break;
    case 'bodybuilder': ok = !!poseBodybuilder(lm); break;   // post7
    case 'splitLegs':   ok = !!poseSplitLegs(lm); break;     // post8
    case 'balletLift':  ok = !!poseBalletLift(lm); break;    // post9
    case 'gunStack':    ok = !!poseGunStack(lm); break;      // post10
    case 'oBelly':      ok = !!poseOBelly(lm); break;        // post13
    case 'xChest':      ok = !!poseXChest(lm); break;        // post14
    case 'monkey':      ok = !!poseMonkey(lm); break;        // post15
    case 'sitKnees':    ok = !!poseSitHandsOnKnees(lm); break;   // post16
    case 'splitArmsUp': ok = !!poseSplitLegsArmsUp(lm); break;   // post17
    case 'armAtHead':   ok = !!poseArmAtHeadLevel(lm); break;     // post19
    default:         ok = !!bothHandsOnHead(lm);
  }
  __poseHits.push(ok);
  if(__poseHits.length > GESTURE_NEXT.window) __poseHits.shift();

  // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ü‡∏£‡∏°‡∏ó‡∏µ‡πà ‚Äú‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‚Äù ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
  const good = __poseHits.reduce((a,b)=>a+(b?1:0), 0);
  if(good >= GESTURE_NEXT.framesNeeded){
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á + ‡∏ï‡∏±‡πâ‡∏á cooldown
    __poseHits.length = 0;
    __poseCooldownUntil = performance.now() + GESTURE_NEXT.cooldownMs;

    try{
      // ‡πÉ‡∏ä‡πâ fastNext ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ, ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡∏•‡∏≠‡∏á qDecor
      const fast = document.getElementById('fastNext');
      if (typeof awaitingContinue !== 'undefined' && typeof ended !== 'undefined') {
        if (awaitingContinue && !ended) {
          (fast || qDecor)?.click();
        }
      } else {
        // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏™‡πÇ‡∏Ñ‡∏õ‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£: ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å fastNext ‡πÄ‡∏â‡∏¢ ‡πÜ
        (fast || qDecor)?.click();
      }
    }catch(_){}
  }
}

function drawPoseAndColliders(res){ 
const sw=innerWidth, sh=innerHeight; ctx.clearRect(0,0,sw,sh); if(!res?.landmarks?.length) 
return; const lm=res.landmarks[0]; 
updateNextPose(lm); // ‚≠êÔ∏è ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡πà‡∏≤‡πÅ‡∏ï‡∏∞‡∏´‡∏±‡∏ß‡∏™‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏á ‚Üí ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å NEXT ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏°

drawHandBall(13,15,lm); drawHandBall(14,16,lm) }
function runLoop(){ const step=()=>{ if(!video.videoWidth){ raf=requestAnimationFrame(step); return } const now=performance.now(); try{ const {sX,sY,sW,sH}=coverCropRect(); detectCtx.drawImage(video, sX,sY,sW,sH, 0,0, detectCanvas.width, detectCanvas.height); const res=landmarker.detectForVideo(detectCanvas, now); drawPoseAndColliders(res) }catch(e){} raf=requestAnimationFrame(step) }; raf=requestAnimationFrame(step) }
async function startCamera(){ await ensureLandmarker(); stream = await navigator.mediaDevices.getUserMedia({ video: { width: 960, height: 540, frameRate: 30, facingMode: 'user' }, audio: false }); video.srcObject=stream; await video.play().catch(()=>{}); const vw=video.videoWidth||640, vh=video.videoHeight||480; const ratio=vw/vh; detectCanvas.width=DETECT_W; detectCanvas.height=Math.round(DETECT_W/ratio); video.style.display='block'; cvs.style.display='block'; camBtn.textContent='üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á: ‡πÄ‡∏õ‡∏¥‡∏î'; CAM_ON=true; fitCanvas(); runLoop() }
function stopCamera(){ cancelAnimationFrame(raf); if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null } try{ video.pause() }catch(e){} video.removeAttribute('srcObject'); video.style.display='none'; cvs.style.display='none'; ctx.clearRect(0,0,innerWidth,innerHeight); camBtn.textContent='üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á: ‡∏õ‡∏¥‡∏î'; CAM_ON=false; fitCanvas() }
camBtn.addEventListener('click', async ()=>{ if(!stream){ try{ await startCamera() }catch(err){ camBtn.textContent='üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á: ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï'; camBtn.disabled=true } } else { stopCamera() } });
document.addEventListener('visibilitychange', ()=>{ if(document.hidden && stream) stopCamera() });
</script>

<!-- ===== Preload Overlay ===== -->
<div id="preloadOverlay">
  <div id="preloadText" style="font-size:20px">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶ 0%</div>
  <div style="width:min(80vw,480px); height:10px; background:#ffffff22; border-radius:999px; overflow:hidden">
    <div id="preloadBar" style="height:100%; width:0%; background:#10b981"></div>
  </div>
  <div style="font-size:12px;opacity:.8">...‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</div>
</div>
<div id="flashOverlay" aria-hidden="true"></div>
<div id="emojiBurst" aria-hidden="true"></div>
</body>
</html>





